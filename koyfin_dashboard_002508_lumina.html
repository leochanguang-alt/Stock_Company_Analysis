<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>002508.SZ - Financial Analysis (Koyfin Style)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Inter:wght@300;400;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script>
        // Fallback if CDN fails
        if (typeof Papa === 'undefined') {
            document.write('<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"><\/script>');
        }
    </script>
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #111111;
            --header-bg: rgba(17, 17, 17, 0.8);
            --card-bg: rgba(255, 255, 255, 0.03);
            --text-color: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --text-dim: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #d4af37; /* Gold accent for luxury feel */
            --accent-hover: #b8962e;
            --positive: #4ade80;
            --positive-bg: rgba(74, 222, 128, 0.1);
            --negative: #f87171;
            --negative-bg: rgba(248, 113, 113, 0.1);
            --hover-bg: rgba(255, 255, 255, 0.08);
            --font-display: 'Cormorant Garamond', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            font-size: 14px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* WebGL Canvas Background */
        #webgl-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* Layout Structure */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation (Lumina Style) */
        .sidebar {
            width: 300px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 100;
            background: linear-gradient(to right, rgba(0,0,0,0.8), transparent);
        }

        .logo-section h1 {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 300;
            margin: 0;
            letter-spacing: 2px;
            font-style: italic;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 40px 0;
        }

        .nav-item {
            margin: 20px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            opacity: 0.5;
        }

        .nav-item:hover, .nav-item.active {
            opacity: 1;
            transform: translateX(10px);
        }

        .nav-index {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--accent-color);
        }

        .nav-label {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 400;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 300px;
            flex: 1;
            padding: 60px 80px;
            max-width: 1400px;
        }

        .section-header {
            margin-bottom: 60px;
        }

        .section-index {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--accent-color);
            display: block;
            margin-bottom: 10px;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 64px;
            font-weight: 300;
            margin: 0;
            line-height: 1;
        }

        .section-desc {
            font-family: var(--font-sans);
            font-size: 16px;
            color: var(--text-muted);
            margin-top: 20px;
            max-width: 600px;
            line-height: 1.6;
            font-weight: 300;
        }

        /* Content Cards */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 2px; /* Sharp corners for luxury feel */
            padding: 30px;
            transition: transform 0.4s ease;
        }

        .glass-card:hover {
            border-color: rgba(212, 175, 55, 0.3);
        }

        /* Original Components Styling Overrides */
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-sans);
            font-size: 13px;
        }

        .financial-table th {
            text-align: left;
            padding: 15px 10px;
            color: var(--text-dim);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-color);
        }

        .financial-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .financial-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .badge {
            font-family: var(--font-mono);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
        }

        /* Hide original elements that we're replacing */
        .header, .tabs-container, .view-switch { display: none !important; }

        /* Animation Classes */
        .fade-in { opacity: 0; transform: translateY(20px); }

        /* Chart Container */
        .chart-container {
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }
    </style>

        .table-wrapper {
            overflow-x: auto;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: var(--header-bg);
            color: var(--text-muted);
            font-weight: 600;
            text-align: right;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 5;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 15;
            background: var(--header-bg);
            min-width: 220px;
        }

        td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 10;
            font-weight: 500;
            color: var(--text-color);
        }

        tr {
            transition: background 0.15s ease;
        }

        tr:hover td { 
            background: var(--hover-bg); 
        }
        
        tr:hover td:first-child { 
            background: var(--hover-bg); 
        }

        /* Section Header Row */
        .section-header {
            background: var(--primary-bg) !important;
            font-weight: 700 !important;
            color: var(--text-color) !important;
            cursor: pointer;
        }

        .section-header td {
            background: var(--primary-bg) !important;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .section-header td:first-child {
            background: var(--primary-bg) !important;
        }

        .section-header:hover td {
            background: var(--hover-bg) !important;
        }

        .section-header .toggle-icon {
            display: inline-block;
            width: 18px;
            margin-right: 8px;
            color: var(--accent-color);
            font-size: 10px;
        }

        /* Indented rows */
        .indent-1 td:first-child { padding-left: 32px; }
        .indent-2 td:first-child { padding-left: 48px; color: var(--text-muted); }
        .indent-3 td:first-child { padding-left: 64px; color: var(--text-dim); font-size: 11px; }

        /* Bold metric rows */
        .metric-bold td:first-child { 
            font-weight: 700; 
            color: var(--text-color);
        }

        /* Value colors */
        .val-positive { 
            color: var(--positive); 
            background: var(--positive-bg);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .val-negative { 
            color: var(--negative); 
            background: var(--negative-bg);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Hidden rows */
        .row-hidden { display: none; }

        .loading {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .loading::before {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            margin: 0 auto 16px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 12px 16px;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
                padding: 16px;
            }
            
            .company-search {
                width: 100%;
            }
            
            .view-switch {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <canvas id="webgl-canvas"></canvas>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo-section">
                <h1>002508.SZ</h1>
                <div style="font-family: var(--font-mono); font-size: 10px; color: var(--text-dim); margin-top: 5px; letter-spacing: 1px;">QUANTITATIVE ANALYSIS</div>
            </div>

            <ul class="nav-list">
                <li class="nav-item active" onclick="switchTab('Highlights')">
                    <span class="nav-index">01</span>
                    <span class="nav-label">Highlights</span>
                </li>
                <li class="nav-item" onclick="switchTab('IncomeStatement')">
                    <span class="nav-index">02</span>
                    <span class="nav-label">Financials</span>
                </li>
                <li class="nav-item" onclick="switchTab('Holders')">
                    <span class="nav-index">03</span>
                    <span class="nav-label">Holders</span>
                </li>
                <li class="nav-item" onclick="switchTab('Top10')">
                    <span class="nav-index">04</span>
                    <span class="nav-label">Top 10</span>
                </li>
            </ul>

            <div class="sidebar-footer">
                <div class="company-search-box">
                    <input type="text" id="company-search-input" placeholder="SEARCH SYMBOL..." value="002508">
                    <datalist id="company-symbols"></datalist>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Section Header -->
            <header class="section-header fade-in">
                <span class="section-index" id="current-section-index">01</span>
                <h2 class="section-title" id="current-section-title">Highlights</h2>
                <p class="section-desc" id="current-section-desc">
                    A comprehensive look at the core performance metrics, valuation, and market position.
                </p>
            </header>

            <!-- Dynamic Content Area -->
            <div class="table-container">
                <div class="table-wrapper" id="table-box">
                    <div class="loading">Loading data...</div>
                </div>
            </div>

            <!-- Holders Specific Content (Hidden by default) -->
            <div id="holders-charts" style="display: none; margin-top: 40px;">
                <div class="content-grid">
                    <div class="glass-card fade-in">
                        <div id="holdersChart1" class="chart-container"></div>
                    </div>
                    <div class="glass-card fade-in">
                        <div id="holdersChart2" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Original Hidden Elements for Logic -->
    <div style="display:none">
        <div class="header">
            <div class="company-info" id="company-info"></div>
            <div class="view-switch">
                <button class="view-btn" id="ltm-btn" onclick="setView('ltm', this)">LTM</button>
                <button class="view-btn active" id="annual-btn" onclick="setView('annual', this)">Annual</button>
            </div>
        </div>
        <div class="tabs-container" id="tabs"></div>
    </div>

<script>
let currentView = 'annual';
let currentTab = 'Model100';
let rawData = { ltm: [], annual: [] };
let collapsedSections = {};
let companyIndex = new Map();
let companyLookupLoaded = false;
let companySuggestions = [];
let companySearchTimer = null;
const dataCache = new Map();
const VALIDATION_MODE = true;

// Supabase config (public read)
const SUPABASE_URL = 'https://fsyxnkzrgozmjyoxcvvh.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzeXhua3pyZ296bWp5b3hjdnZoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODExODA1MSwiZXhwIjoyMDgzNjk0MDUxfQ.k5c89GZOeM3w5ZhrhUc_7y4A9LYz-FsimHxwXcR2oyU';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Tab configurations with sections
const tabConfigs = {
    'Highlights': {
        'Key Financials': [
            { key: 'Revenue', label: 'Total Revenues', bold: true },
            { key: 'Rev_YoY', label: 'YoY Growth %', indent: 1, format: 'pct' },
            { key: 'Gross_Profit', label: 'Gross Profit', bold: true },
            { key: 'Gross_Margin', label: 'Gross Profit Margin', indent: 1, format: 'pct' },
            { key: 'EBITDA', label: 'EBITDA', bold: true },
            { key: 'EBITDA_Margin', label: 'EBITDA Margin', indent: 1, format: 'pct' },
            { key: 'Net_Income', label: 'Net Income', bold: true },
            { key: 'Net_Margin', label: 'Net Income Margin', indent: 1, format: 'pct' },
            { key: 'Diluted_EPS', label: 'Diluted EPS' },
            { key: 'EPS_YoY', label: 'YoY Growth %', indent: 1, format: 'pct' },
            { key: 'PE', label: 'Price / Earnings - P/E', format: 'ratio' }
        ],
        'Capital Structure': [
            { key: 'Market_Cap', label: 'Market Capitalization', bold: true },
            { key: 'Cash_Equivalents', label: 'Cash & Equivalents', indent: 1 },
            { key: 'Total_Debt', label: 'Total Debt', indent: 1 },
            { key: 'Minority_Interest', label: 'Minority Interest', indent: 1 },
            { key: 'EV', label: 'Enterprise Value - EV', bold: true }
        ],
        'Cash Flow Analysis': [
            { key: 'OCF', label: 'Cash from Operations', bold: true },
            { key: 'OCF_YoY', label: 'YoY Growth %', indent: 1, format: 'pct' },
            { key: 'CapEx', label: 'Capital Expenditure' },
            { key: 'CapEx_YoY', label: 'YoY Growth %', indent: 1, format: 'pct' }
        ]
    },
    'IncomeStatement': {
        'Revenues': [
            { key: 'Revenue', label: 'Total Revenues', bold: true },
            { key: 'Main_Revenue', label: 'Revenues', indent: 1 },
            { key: 'Other_Revenue', label: 'Other Revenues', indent: 1 },
            { key: 'Rev_YoY', label: 'YoY Growth %', format: 'pct' }
        ],
        'Gross Profit': [
            { key: 'COGS', label: 'Cost Of Revenues', indent: 1 },
            { key: 'Gross_Profit', label: 'Gross Profit (Loss)', bold: true },
            { key: 'Gross_Profit_YoY', label: 'YoY Growth %', format: 'pct' }
        ],
        'Operating Income & Expenses': [
            { key: 'SGA_Exp', label: 'Selling General & Admin Expenses' },
            { key: 'RD_Exp', label: 'R&D Expenses' },
            { key: 'DA', label: 'Depreciation & Amortization' },
            { key: 'Other_Operating_Exp', label: 'Other Operating Expenses' },
            { key: 'Operating_Income', label: 'Operating Income', bold: true }
        ],
        'Net Interest Expense': [
            { key: 'Net_Interest_Exp', label: 'Net Interest Expenses', bold: true },
            { key: 'Interest_Exp', label: 'Interest Expense', indent: 1 },
            { key: 'Interest_And_Investment_Income', label: 'Interest And Investment Income', indent: 1 }
        ],
        'Earnings Before Taxes (EBT)': [
            { key: 'Equity_Method_Income', label: 'Income (Loss) On Equity Affiliates' },
            { key: 'Non_Operating_Net', label: 'Other Non Operating Income (Expenses)' },
            { key: 'EBT_Excl_Unusual', label: 'EBT, Excl. Unusual Items' },
            { key: 'Total_Impairment', label: 'Impairment Charges' },
            { key: 'Gain_On_Asset_Sale', label: 'Gain (Loss) On Sale Of Assets' },
            { key: 'Other_Unusual_Items', label: 'Other Unusual Items, Total' },
            { key: 'Pretax_Income', label: 'EBT, Incl. Unusual Items', bold: true }
        ],
        'Earnings from Operations | Net Income': [
            { key: 'Income_Tax_Exp', label: 'Income Tax Expense', indent: 1 },
            { key: 'Earnings_Continuing', label: 'Earnings From Continuing Operations' },
            { key: 'Minority_Interest_Income', label: 'Minority Interest', indent: 1 },
            { key: 'Net_Income', label: 'Net Income', bold: true },
            { key: 'Net_Income_Common', label: 'Net Income to Common Incl Extra Items' }
        ],
        'Supplemental Items': [
            { key: 'EBITDA', label: 'EBITDA', bold: true },
            { key: 'EBIT', label: 'EBIT' },
            { key: 'Selling_Exp', label: 'Selling and Marketing Expenses', indent: 1 },
            { key: 'Admin_Exp', label: 'General and Administrative Expenses', indent: 1 }
        ]
    },
    'BalanceSheet': {
        'Assets': [
            { key: 'Total_Cash', label: 'Total Cash And Short Term Investments', bold: true },
            { key: 'Cash_Equivalents', label: 'Cash And Equivalents', indent: 1 },
            { key: 'Short_Term_Investments', label: 'Short Term Investments', indent: 1 },
            { key: 'Total_Receivables', label: 'Total Receivables', bold: true },
            { key: 'Accounts_Receivable', label: 'Accounts Receivable', indent: 1 },
            { key: 'Other_Receivables', label: 'Other Receivables', indent: 1 },
            { key: 'Inventory', label: 'Inventory' },
            { key: 'Prepaid_Expenses', label: 'Prepaid Expenses' },
            { key: 'Other_Current_Assets', label: 'Other Current Assets' },
            { key: 'Total_Current_Assets', label: 'Total Current Assets', bold: true },
            { key: 'Total_PPE_Koyfin', label: 'Net Property Plant And Equipment', bold: true },
            { key: 'Gross_PPE', label: 'Gross Property Plant And Equipment', indent: 1 },
            { key: 'Accumulated_Depreciation', label: 'Accumulated Depreciation', indent: 1 },
            { key: 'LT_Equity_Investment', label: 'Long-term Investments' },
            { key: 'Goodwill', label: 'Goodwill' },
            { key: 'Intangible_Assets', label: 'Other Intangibles' },
            { key: 'Deferred_Tax_Asset', label: 'Deferred Tax Assets Long-Term' },
            { key: 'LT_Prepaid_Expenses', label: 'Deferred Charges Long-Term' },
            { key: 'Other_NonCurrent_Assets', label: 'Other Long-Term Assets' },
            { key: 'Total_Assets', label: 'Total Assets', bold: true }
        ],
        'Liabilities': [
            { key: 'Accounts_Payable', label: 'Accounts Payable' },
            { key: 'Employee_Benefits_Payable', label: 'Accrued Expenses' },
            { key: 'Short_Term_Debt', label: 'Short-Term Debt', indent: 1 },
            { key: 'Current_Portion_LT_Debt', label: 'Current Portion of Long-Term Debt', indent: 1 },
            { key: 'Taxes_Payable', label: 'Current Income Taxes Payable' },
            { key: 'Unearned_Revenue_Total', label: 'Unearned Revenue Current, Total' },
            { key: 'Other_Current_Liabilities', label: 'Other Current Liabilities' },
            { key: 'Total_Current_Liabilities', label: 'Total Current Liabilities', bold: true },
            { key: 'Long_Term_Debt', label: 'Long-Term Debt' },
            { key: 'Lease_Liabilities', label: 'Long-Term Leases' },
            { key: 'Unearned_Revenue_NonCurrent', label: 'Unearned Revenue Non Current' },
            { key: 'Deferred_Tax_Liability', label: 'Deferred Tax Liability Non Current' },
            { key: 'Other_NonCurrent_Liabilities', label: 'Other Non Current Liabilities' },
            { key: 'Total_Liabilities', label: 'Total Liabilities', bold: true },
            { key: 'Common_Equity', label: 'Common Equity', bold: true },
            { key: 'Common_Stock', label: 'Common Stock', indent: 1 },
            { key: 'Additional_Paid_In_Capital', label: 'Additional Paid In Capital', indent: 1 },
            { key: 'Retained_Earnings', label: 'Retained Earnings', indent: 1 },
            { key: 'Treasury_Stock', label: 'Treasury Stock', indent: 1 },
            { key: 'Other_Comprehensive_Income', label: 'Comprehensive Income and Other', indent: 1 },
            { key: 'Total_Equity', label: 'Total Equity', bold: true },
            { key: 'Total_Assets', label: 'Total Liabilities And Equity', bold: true }
        ],
        'Supplemental Items': [
            { key: 'Shares_Outstanding', label: 'Total Common Shares Outstanding' },
            { key: 'Book_Value_Per_Share', label: 'Book Value / Share' },
            { key: 'Tangible_Book_Value', label: 'Tangible Book Value' },
            { key: 'Tangible_BV_Per_Share', label: 'Tangible Book Value Per Share' },
            { key: 'Total_Debt', label: 'Total Debt' },
            { key: 'Net_Debt', label: 'Net Debt' },
            { key: 'LT_Equity_Investment', label: 'Equity Method Investments' }
        ]
    },
    'CashFlow': {
        'Net Income': [
            { key: 'DA', label: 'Depreciation & Amortization, Total' },
            { key: 'Net_Income', label: 'Net Income', bold: true }
        ],
        'Cash from Operations': [
            { key: 'Net_Income', label: 'Net Income' },
            { key: 'DA', label: 'Depreciation & Amortization, Total', indent: 1 },
            { key: 'Change_In_AR', label: 'Change In Accounts Receivable', indent: 1 },
            { key: 'Change_In_Inventory', label: 'Change In Inventories', indent: 1 },
            { key: 'Change_In_AP', label: 'Change In Accounts Payable', indent: 1 },
            { key: 'Other_Operating_Activities', label: 'Other Operating Activities, Total', indent: 1 },
            { key: 'OCF', label: 'Cash from Operations', bold: true }
        ],
        'Cash from Investing': [
            { key: 'CapEx', label: 'Capital Expenditure' },
            { key: 'Proceeds_From_Asset_Sales', label: 'Sale of Property, Plant, and Equipment', indent: 1 },
            { key: 'Cash_Acquisitions', label: 'Cash Acquisitions', indent: 1 },
            { key: 'Cash_Divestitures', label: 'Divestitures', indent: 1 },
            { key: 'Investment_In_Securities', label: 'Investment in Mkt and Equity Securities, Total', indent: 1 },
            { key: 'Other_Investing_Activities', label: 'Other Investing Activities, Total', indent: 1 },
            { key: 'ICF', label: 'Cash from Investing', bold: true }
        ],
        'Cash from Financing': [
            { key: 'Total_Debt_Issued', label: 'Total Debt Issued', indent: 1 },
            { key: 'Total_Debt_Repaid', label: 'Total Debt Repaid', indent: 1 },
            { key: 'Proceeds_From_Equity', label: 'Issuance of Common Stock', indent: 1 },
            { key: 'Treasury_Stock', label: 'Repurchase of Common Stock', indent: 1 },
            { key: 'Dividends_Paid', label: 'Common & Preferred Stock Dividends Paid' },
            { key: 'Common_Dividends_Paid', label: 'Common Dividends Paid', indent: 2 },
            { key: 'Other_Financing_Activities', label: 'Other Financing Activities', indent: 1 },
            { key: 'CFF', label: 'Cash from Financing', bold: true }
        ],
        'Net Change in Cash': [
            { key: 'FX_Effect', label: 'Foreign Exchange Rate Adjustments', indent: 1 },
            { key: 'Net_Change_In_Cash', label: 'Net Change in Cash', bold: true }
        ],
        'Supplemental Items': [
            { key: 'FCF', label: 'Free Cash Flow', bold: true },
            { key: 'FCF_Per_Share', label: 'Free Cash Flow per Share' },
            { key: 'Taxes_Paid', label: 'Cash Income Tax Paid (Refund)' },
            { key: 'Working_Capital_Change', label: 'Change In Net Working Capital' },
            { key: 'Net_Debt_Issued', label: 'Net Debt Issued / Repaid' }
        ]
    },
    'Multiples': {
        'Sales | Revenues': [
            { key: 'EV_Sales', label: 'EV / Sales (LTM)', format: 'ratio' },
            { key: 'PS', label: 'Price / Sales (LTM)', format: 'ratio' }
        ],
        'Earnings': [
            { key: 'EV_EBITDA', label: 'EV / EBITDA (LTM)', format: 'ratio' },
            { key: 'EV_EBIT', label: 'EV / EBIT (LTM)', format: 'ratio' },
            { key: 'PE', label: 'Price / Earnings (LTM)', format: 'ratio' }
        ],
        'Book Value': [
            { key: 'PB', label: 'Price / Book (LTM)', format: 'ratio' },
            { key: 'P_TangibleBV', label: 'Price / Tangible Book Value (LTM)', format: 'ratio' }
        ]
    },
    'EnterpriseValue': {
        'Capital Structure': [
            { key: 'Market_Cap', label: 'Market Capitalization', bold: true },
            { key: 'Total_Cash', label: 'Cash & Short Term Investments', indent: 1 },
            { key: 'Total_Debt', label: 'Total Debt', indent: 1 },
            { key: 'Minority_Interest', label: 'Minority Interest', indent: 1 },
            { key: 'EV', label: 'Enterprise Value', bold: true }
        ],
        'Enterprise Value Multiples': [
            { key: 'EV_Sales', label: 'EV / Sales', format: 'ratio' },
            { key: 'EV_EBITDA', label: 'EV / EBITDA', format: 'ratio' },
            { key: 'EV_EBIT', label: 'EV / EBIT', format: 'ratio' }
        ],
        'Capitalization': [
            { key: 'Total_Capital', label: 'Total Capital', bold: true },
            { key: 'Total_Equity', label: 'Total Common Equity', indent: 1 },
            { key: 'Total_Debt', label: 'Total Debt', indent: 1 },
            { key: 'Minority_Interest', label: 'Minority Interest', indent: 1 },
            { key: 'Return_On_Capital', label: 'Return on Total Capital', format: 'pct' },
            { key: 'Debt_to_Capital', label: 'Total Debt / Total Capital', format: 'pct' },
            { key: 'Debt_to_Equity', label: 'Total Debt / Equity', format: 'pct' },
            { key: 'Debt_to_EBITDA', label: 'Total Debt / EBITDA', format: 'ratio' },
            { key: 'LT_Debt_to_Capital', label: 'Long-Term Debt / Total Capital', format: 'pct' }
        ]
    },
    'Profitability': {
        'Returns': [
            { key: 'ROA', label: 'Return on Assets', format: 'pct' },
            { key: 'ROE', label: 'Return On Equity', format: 'pct' },
            { key: 'ROIC', label: 'Return on Invested Capital (ROIC)', format: 'pct' },
            { key: 'Return_On_Capital', label: 'Return on Total Capital', format: 'pct' },
            { key: 'Return_On_Common_Equity', label: 'Return on Common Equity', format: 'pct' }
        ],
        'Margins': [
            { key: 'EBITDA_Margin', label: 'EBITDA Margin', format: 'pct' },
            { key: 'EBITA_Margin', label: 'EBITA Margin', format: 'pct' },
            { key: 'EBIT_Margin', label: 'EBIT Margin', format: 'pct' },
            { key: 'EBT_Margin', label: 'EBT Margin', format: 'pct' },
            { key: 'EBT_Excl_Unusual_Margin', label: 'EBT Excl. Non-Recurring Items Margin', format: 'pct' },
            { key: 'Gross_Margin', label: 'Gross Profit Margin', format: 'pct' },
            { key: 'SGA_Margin', label: 'SG&A Margin', format: 'pct' },
            { key: 'Net_Margin', label: 'Net Income Margin', format: 'pct' },
            { key: 'Net_Avail_Common_Margin', label: 'Net Avail. For Common Margin', format: 'pct' },
            { key: 'Normalized_Net_Income_Margin', label: 'Normalized Net Income Margin', format: 'pct' }
        ],
        'Asset Turnovers': [
            { key: 'Receivables_Turnover', label: 'Receivables Turnover (Average Receivables)', format: 'ratio' },
            { key: 'Fixed_Assets_Turnover', label: 'Fixed Assets Turnover (Average Fixed Assets)', format: 'ratio' },
            { key: 'Inventory_Turnover', label: 'Inventory Turnover (Average Inventory)', format: 'ratio' },
            { key: 'Asset_Turnover', label: 'Asset Turnover', format: 'ratio' },
            { key: 'Days_Outstanding_Inventory', label: 'Days Outstanding Inventory (Avg)', format: 'decimal' }
        ],
        'Short-term Liquidity': [
            { key: 'Current_Ratio', label: 'Current Ratio', format: 'ratio' },
            { key: 'Quick_Ratio', label: 'Quick Ratio', format: 'ratio' },
            { key: 'Days_Sales_Outstanding', label: 'Days Sales Outstanding (Average Receivables)', format: 'decimal' },
            { key: 'Days_Payable_Outstanding', label: 'Days Payable Outstanding (Avg)', format: 'decimal' },
            { key: 'Cash_Conversion_Cycle', label: 'Cash Conversion Cycle (Average Days)', format: 'decimal' },
            { key: 'Operating_Cash_Flow_to_Current_Liabilities', label: 'Operating Cash Flow to Current Liabilities', format: 'ratio' }
        ]
    },
    'ROIC': {
        'Return on Invested Capital (ROIC) = NOPAT / Average Invested Capital': [
            { key: 'NOPAT', label: 'Net Operating Profit After Tax (NOPAT)' },
            { key: 'Avg_Invested_Capital', label: 'Invested Capital, Average' },
            { key: 'ROIC', label: 'Return on Invested Capital (ROIC)', bold: true, format: 'pct' }
        ],
        'Net Operating Profit After Tax (NOPAT)': [
            { key: 'EBIT', label: 'EBIT' },
            { key: 'Income_Tax_Exp', label: 'Income Tax Expense' },
            { key: 'NOPAT', label: 'Net Operating Profit After Tax (NOPAT)', bold: true }
        ],
        'Average Invested Capital': [
            { key: 'Long_Term_Debt', label: 'Long Term Debt' },
            { key: 'Short_Term_Debt', label: 'Short Term Debt' },
            { key: 'Total_Equity', label: 'Total Equity' },
            { key: 'Lease_Liabilities', label: 'Long Term Leases' },
            { key: 'Invested_Capital', label: 'Invested Capital', bold: true },
            { key: 'Avg_Invested_Capital', label: 'Invested Capital, Average', bold: true }
        ]
    },
    'Solvency': {
        'Debt Analysis': [
            { key: 'Debt_to_Equity', label: 'Total Debt / Equity', format: 'pct' },
            { key: 'Debt_to_Capital', label: 'Total Debt / Capital', format: 'pct' },
            { key: 'LT_Debt_to_Equity', label: 'Long-Term Debt / Equity', format: 'pct' },
            { key: 'LT_Debt_to_Capital', label: 'Long-Term Debt / Capital', format: 'pct' },
            { key: 'Liabilities_to_Assets', label: 'Total Liabilities / Total Assets', format: 'pct' }
        ],
        'Interest Rate Coverage': [
            { key: 'Interest_Coverage_EBIT', label: 'EBIT / Interest Expense', format: 'ratio' },
            { key: 'Interest_Coverage_EBITDA', label: 'EBITDA / Interest Expense', format: 'ratio' },
            { key: 'Interest_Coverage_EBITDA_CapEx', label: '(EBITDA - Capex) / Interest Expense', format: 'ratio' }
        ],
        'Debt Coverage': [
            { key: 'Debt_to_EBITDA', label: 'Total Debt / EBITDA', format: 'ratio' },
            { key: 'Net_Debt_to_EBITDA', label: 'Net Debt / EBITDA', format: 'ratio' }
        ],
        'Liquidity': [
            { key: 'Current_Ratio', label: 'Current Ratio', format: 'ratio' }
        ],
        'Bankruptcy Risk': [
            { key: 'Altman_Z_Score', label: 'Altman Z-Score', format: 'decimal' }
        ]
    },
    'Model100': {
        'Default group': [
            { key: 'EV', label: 'Enterprise Value - EV', bold: true },
            { key: 'Total_Debt', label: 'Total Debt' },
            { key: 'Market_Cap', label: 'Market Capitalization' },
            { key: 'Cash_Equivalents', label: 'Cash And Equivalents' },
            { key: 'Minority_Interest', label: 'Minority Interest (Balance Sheet)' },
            { key: 'Total_Assets', label: 'Total Assets' },
            { key: 'OCF', label: 'Cash from Operations' },
            { key: 'Working_Capital_Change', label: 'Change In Net Working Capital' },
            { key: 'Total_Equity', label: 'Total Equity' },
            { key: 'Dividends_Paid', label: 'Common Dividends Paid' },
            { key: 'Altman_Z_Score', label: 'Altman Z-Score', format: 'decimal' },
            { key: 'ROIC', label: 'Return on Invested Capital (ROIC)', format: 'pct' },
            { key: 'Working_Capital', label: 'Working Capital' },
            { key: 'Revenue', label: 'Total Revenues' },
            { key: 'COGS', label: 'Cost Of Revenues' },
            { key: 'Gross_Profit', label: 'Gross Profit' },
            { key: 'Gross_Margin', label: 'Gross Profit Margin %', format: 'pct' }
        ]
    },
    'Holders': {
        '股东人数分析': [
            { key: 'holder_count', label: '股东总户数', bold: true, format: 'integer' },
            { key: 'holder_count_change_pct', label: '总户数减少率', indent: 1, format: 'pct_signed' },
            { key: 'Market_Cap_Billion', label: '总市值(亿元)', bold: true, format: 'decimal' },
            { key: 'market_cap_change_pct', label: '总市值增加率', indent: 1, format: 'pct_signed' },
            { key: 'relative_strength', label: '相对上证指数强度', format: 'pct_signed' },
            { key: 'avg_shares_per_holder', label: '户均持股金额(万元)', bold: true, format: 'decimal' },
            { key: 'avg_shares_change_pct', label: '户均持股金额增长率', indent: 1, format: 'pct_signed' }
        ],
        '上证指数对比': [
            { key: 'sh_index', label: '上证指数', format: 'integer' },
            { key: 'sh_index_change_pct', label: '上证指数涨跌', format: 'pct_signed' }
        ]
    }
};

// 股东数据缓存
let holdersData = [];
let holdersDataLoaded = false;

// TOP 10 股东数据缓存
let top10ShareholdersData = [];
let top10DataLoaded = false;

function initTabs() {
    const container = document.getElementById('tabs');
    const tabNames = ['Highlights', 'IncomeStatement', 'BalanceSheet', 'CashFlow', 'Multiples', 'EnterpriseValue', 'Profitability', 'ROIC', 'Solvency', 'Holders', 'Top10Shareholders', 'Model100'];
    const tabLabels = {
        'Highlights': 'Highlights',
        'IncomeStatement': 'Income Statement',
        'BalanceSheet': 'Balance Sheet',
        'CashFlow': 'Cash Flow',
        'Multiples': 'Multiples',
        'EnterpriseValue': 'Enterprise Value',
        'Profitability': 'Profitability',
        'ROIC': 'ROIC',
        'Solvency': 'Solvency',
        'Holders': 'Holders',
        'Top10Shareholders': 'TOP 10 Shareholder',
        'Model100': 'Model100'
    };
    
    tabNames.forEach(tab => {
        const el = document.createElement('div');
        el.className = `tab ${tab === currentTab ? 'active' : ''}`;
        el.innerText = tabLabels[tab];
        el.onclick = () => setTab(tab, el);
        container.appendChild(el);
    });
}

const accountMapping = {
    // Income Statement
    '营业收入': 'Revenue',
    '营业总收入': 'Total_Revenue_Gross',
    '其他业务收入': 'Other_Business_Revenue',
    '其他业务利润': 'Other_Business_Profit',
    '其他业务成本': 'Other_Business_Cost',
    '营业成本': 'COGS',
    '营业总成本': 'Total_Operating_Cost',
    '营业利润': 'Operating_Income',
    '利润总额': 'Pretax_Income',
    '所得税费用': 'Income_Tax_Exp',
    '净利润': 'Net_Income',
    '归属于母公司所有者的净利润': 'Net_Income_Parent',
    '少数股东损益': 'Minority_Interest_Income',
    '持续经营净利润': 'Continuing_Operations_Income',
    '销售费用': 'Selling_Exp',
    '管理费用': 'Admin_Exp',
    '研发费用': 'RD_Exp',
    '财务费用': 'Fin_Exp',
    '利息收入': 'Interest_Inc',
    '利息支出': 'Interest_Exp',
    '利息费用': 'Interest_Exp_Alt',
    '营业税金及附加': 'Taxes_Surcharges',
    '资产减值损失': 'Asset_Impairment',
    '信用减值损失': 'Credit_Impairment',
    '资产处置收益': 'Asset_Disposal_Gain',
    '非流动资产处置利得': 'NonCurrent_Asset_Disposal_Gain',
    '非流动资产处置损失': 'NonCurrent_Asset_Disposal_Loss',
    '投资收益': 'Investment_Income',
    '对联营企业和合营企业的投资收益': 'Equity_Method_Income',
    '公允价值变动收益': 'FV_Change_Income',
    '其他收益': 'Other_Income',
    '营业外收入': 'Non_Operating_Income',
    '营业外支出': 'Non_Operating_Exp',
    '汇兑收益': 'FX_Gain',
    '基本每股收益': 'EPS',
    '稀释每股收益': 'Diluted_EPS',
    // Balance Sheet - Assets
    '资产总计': 'Total_Assets',
    '流动资产合计': 'Total_Current_Assets',
    '货币资金': 'Cash_Equivalents',
    '交易性金融资产': 'Short_Term_Investments',
    '应收账款': 'Accounts_Receivable',
    '应收票据': 'Notes_Receivable',
    '应收票据及应收账款': 'Notes_AR_Combined',
    '应收款项融资': 'Financing_Receivables',
    '预付款项': 'Prepaid_Expenses',
    '其他应收款': 'Other_Receivables',
    '其他应收款(合计)': 'Other_Receivables_Total',
    '存货': 'Inventory',
    '合同资产': 'Contract_Assets',
    '其他流动资产': 'Other_Current_Assets',
    '非流动资产合计': 'Total_NonCurrent_Assets',
    '固定资产净额': 'Net_PPE',
    '固定资产原值': 'Gross_PPE',
    '累计折旧': 'Accumulated_Depreciation',
    '在建工程': 'Construction_In_Progress',
    '在建工程合计': 'Construction_In_Progress_Total',
    '无形资产': 'Intangible_Assets',
    '开发支出': 'Development_Costs',
    '商誉': 'Goodwill',
    '长期股权投资': 'LT_Equity_Investment',
    '其他权益工具投资': 'Other_Equity_Investments',
    '其他非流动金融资产': 'Other_NonCurrent_Financial_Assets',
    '投资性房地产': 'Investment_Property',
    '递延所得税资产': 'Deferred_Tax_Asset',
    '其他非流动资产': 'Other_NonCurrent_Assets',
    '使用权资产': 'Right_Of_Use_Assets',
    '长期待摊费用': 'LT_Prepaid_Expenses',
    '长期应收款': 'LT_Receivables',
    // Balance Sheet - Liabilities
    '负债合计': 'Total_Liabilities',
    '流动负债合计': 'Total_Current_Liabilities',
    '短期借款': 'Short_Term_Debt',
    '应付账款': 'Accounts_Payable',
    '应付票据': 'Notes_Payable',
    '应付票据及应付账款': 'Notes_AP_Combined',
    '预收款项': 'Unearned_Revenue',
    '合同负债': 'Contract_Liabilities',
    '应付职工薪酬': 'Employee_Benefits_Payable',
    '应交税费': 'Taxes_Payable',
    '其他应付款': 'Other_Payables',
    '其他应付款合计': 'Other_Payables_Total',
    '一年内到期的非流动负债': 'Current_Portion_LT_Debt',
    '其他流动负债': 'Other_Current_Liabilities',
    '非流动负债合计': 'Total_NonCurrent_Liabilities',
    '长期借款': 'Long_Term_Debt',
    '应付债券': 'Bonds_Payable',
    '租赁负债': 'Lease_Liabilities',
    '长期应付款': 'LT_Payables',
    '长期应付款合计': 'LT_Payables_Total',
    '长期应付职工薪酬': 'LT_Employee_Benefits',
    '递延所得税负债': 'Deferred_Tax_Liability',
    '递延收益': 'Deferred_Revenue',
    '长期递延收益': 'LT_Deferred_Revenue',
    '其他非流动负债': 'Other_NonCurrent_Liabilities',
    '预计流动负债': 'Accrued_Liabilities',
    // Balance Sheet - Equity
    '所有者权益(或股东权益)合计': 'Total_Equity',
    '归属于母公司股东权益合计': 'Equity_Parent',
    '少数股东权益': 'Minority_Interest',
    '实收资本(或股本)': 'Common_Stock',
    '资本公积': 'Additional_Paid_In_Capital',
    '盈余公积': 'Surplus_Reserve',
    '未分配利润': 'Retained_Earnings',
    '减:库存股': 'Treasury_Stock',
    '其他综合收益': 'Other_Comprehensive_Income',
    // Cash Flow
    '经营活动产生的现金流量净额': 'OCF',
    '投资活动产生的现金流量净额': 'ICF',
    '筹资活动产生的现金流量净额': 'CFF',
    '购建固定资产、无形资产和其他长期资产所支付的现金': 'CapEx',
    '分配股利、利润或偿付利息所支付的现金': 'Dividends_Paid',
    '销售商品、提供劳务收到的现金': 'Cash_From_Sales',
    '收到的税费返还': 'Tax_Refunds',
    '支付给职工以及为职工支付的现金': 'Employee_Cash_Paid',
    '支付的各项税费': 'Taxes_Paid',
    '取得借款收到的现金': 'Proceeds_From_Borrowings',
    '偿还债务支付的现金': 'Repayment_Of_Debt',
    '吸收投资收到的现金': 'Proceeds_From_Equity',
    '现金及现金等价物净增加额': 'Net_Change_In_Cash',
    '处置固定资产、无形资产和其他长期资产所收回的现金净额': 'Proceeds_From_Asset_Sales',
    '投资所支付的现金': 'Cash_For_Investments',
    '收回投资所收到的现金': 'Proceeds_From_Investment_Sales',
    '取得投资收益收到的现金': 'Cash_From_Investment_Income',
    '汇率变动对现金及现金等价物的影响': 'FX_Effect',
    '期初现金及现金等价物余额': 'Beginning_Cash',
    '期末现金及现金等价物余额': 'Ending_Cash',
    '收到的其他与经营活动有关的现金': 'Other_Operating_Cash_In',
    '支付的其他与经营活动有关的现金': 'Other_Operating_Cash_Out',
    '购买商品、接受劳务支付的现金': 'Cash_Paid_For_Goods',
    '收到的其他与投资活动有关的现金': 'Other_Investing_Cash_In',
    '支付的其他与投资活动有关的现金': 'Other_Investing_Cash_Out',
    '取得子公司及其他营业单位支付的现金净额': 'Cash_Acquisitions',
    '处置子公司及其他营业单位收到的现金净额': 'Cash_Divestitures',
    '收到其他与筹资活动有关的现金': 'Other_Financing_Cash_In',
    '支付其他与筹资活动有关的现金': 'Other_Financing_Cash_Out',
    '子公司吸收少数股东投资收到的现金': 'Minority_Investment_Received',
    '子公司支付给少数股东的股利、利润': 'Minority_Dividends_Paid',
    '发行债券收到的现金': 'Bond_Issuance',
    '经营活动现金流入小计': 'Operating_Cash_Inflow',
    '经营活动现金流出小计': 'Operating_Cash_Outflow',
    '投资活动现金流入小计': 'Investing_Cash_Inflow',
    '投资活动现金流出小计': 'Investing_Cash_Outflow',
    '筹资活动现金流入小计': 'Financing_Cash_Inflow',
    '筹资活动现金流出小计': 'Financing_Cash_Outflow',
    '累计折旧': 'Accumulated_Depreciation'
};

const statusCols = [
    'Total_Assets', 'Total_Liabilities', 'Total_Equity', 'Equity_Parent', 'Minority_Interest',
    'Cash_Equivalents', 'Short_Term_Investments', 'Accounts_Receivable', 'Notes_Receivable',
    'Notes_AR_Combined', 'Prepaid_Expenses', 'Other_Receivables', 'Inventory', 'Other_Current_Assets',
    'Total_Current_Assets', 'Total_NonCurrent_Assets', 'Net_PPE', 'Construction_In_Progress',
    'Intangible_Assets', 'Goodwill', 'LT_Equity_Investment', 'Deferred_Tax_Asset',
    'Other_NonCurrent_Assets', 'Right_Of_Use_Assets', 'LT_Prepaid_Expenses',
    'Total_Current_Liabilities', 'Total_NonCurrent_Liabilities', 'Short_Term_Debt',
    'Accounts_Payable', 'Notes_Payable', 'Notes_AP_Combined', 'Unearned_Revenue',
    'Contract_Liabilities', 'Employee_Benefits_Payable', 'Taxes_Payable', 'Other_Payables',
    'Current_Portion_LT_Debt', 'Other_Current_Liabilities', 'Long_Term_Debt', 'Bonds_Payable',
    'Lease_Liabilities', 'LT_Payables', 'Deferred_Tax_Liability', 'Deferred_Revenue',
    'LT_Deferred_Revenue', 'Common_Stock', 'Additional_Paid_In_Capital', 'Surplus_Reserve',
    'Retained_Earnings', 'Treasury_Stock', 'Other_Comprehensive_Income'
];

function parseReportDate(value) {
    if (!value) return null;
    const s = String(value);
    if (/^[0-9]{8}$/.test(s)) {
        return `${s.slice(0, 4)}-${s.slice(4, 6)}-${s.slice(6, 8)}`;
    }
    if (/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(s)) return s;
    return s.slice(0, 10);
}

async function fetchAllFinancials(symbol) {
    const rows = [];
    const pageSize = 1000;
    let from = 0;
    while (true) {
        const { data, error } = await supabaseClient
            .from('company_financials_long')
            .select('symbol,report_date,statement_type,account,value,report_type,updated_at')
            .eq('symbol', symbol)
            .range(from, from + pageSize - 1);
        if (error) throw new Error(error.message || 'Failed to load financials');
        if (!data || data.length === 0) break;
        rows.push(...data);
        if (data.length < pageSize) break;
        from += pageSize;
    }
    return rows;
}

function normalizeMarketCapValue(raw) {
    const val = raw !== null && raw !== undefined ? Number(raw) : NaN;
    if (!isFinite(val)) return null;
    const absVal = Math.abs(val);
    // Heuristic: small values are likely in 亿 (1e8) units
    if (absVal > 0 && absVal < 1e7) return val * 1e8;
    return val;
}

function normalizeMarketCapRecord(row, mapper) {
    const date = parseReportDate(row.date);
    if (!date) return null;
    const cap = normalizeMarketCapValue(mapper(row));
    if (cap === null) return null;
    return { date, cap };
}

async function fetchHoldersData(symbol) {
    try {
        const { data, error } = await supabaseClient
            .from('cn_sharehold_data')
            .select('*')
            .eq('symbol', symbol)
            .order('report_date', { ascending: true });
        
        if (error) {
            console.warn('Failed to fetch holders data:', error.message);
            return [];
        }
        return data || [];
    } catch (err) {
        console.warn('Holders data fetch error:', err);
        return [];
    }
}

async function fetchTop10ShareholdersData(symbol) {
    try {
        // 将纯数字代码转换为带市场前缀的格式
        let querySymbol = symbol;
        if (/^\d{6}$/.test(symbol)) {
            // 根据代码判断市场
            if (symbol.startsWith('6')) {
                querySymbol = `SH${symbol}`;
            } else {
                querySymbol = `SZ${symbol}`;
            }
        }
        
        const { data, error } = await supabaseClient
            .from('cn_top10_sharehold')
            .select('*')
            .eq('symbol', querySymbol)
            .order('report_date', { ascending: true });
        
        if (error) {
            console.warn('Failed to fetch top10 shareholders data:', error.message);
            return [];
        }
        return data || [];
    } catch (err) {
        console.warn('Top10 shareholders data fetch error:', err);
        return [];
    }
}

async function fetchMarketCapHistory(symbol) {
    const pageSize = 1000;
    const candidates = [
        { fields: 'symbol,date,Market_cap', mapper: r => r.Market_cap },
        { fields: 'symbol,date,market_cap', mapper: r => r.market_cap },
        { fields: 'symbol,date,market_capitalization', mapper: r => r.market_capitalization },
        { fields: 'symbol,date,mkt_cap', mapper: r => r.mkt_cap },
        { fields: 'symbol,date,mkt_cap_billion_cny', mapper: r => r.mkt_cap_billion_cny }
    ];

    for (const { fields, mapper } of candidates) {
        const rows = [];
        let from = 0;
        let hadError = false;
        while (true) {
            const { data, error } = await supabaseClient
                .from('stock_valuation_history')
                .select(fields)
                .eq('symbol', symbol)
                .range(from, from + pageSize - 1);
            if (error) {
                hadError = true;
                break;
            }
            if (!data || data.length === 0) break;
            rows.push(...data);
            if (data.length < pageSize) break;
            from += pageSize;
        }
        if (hadError) continue;
        const normalized = rows
            .map(r => normalizeMarketCapRecord(r, mapper))
            .filter(Boolean);
        if (normalized.length) return normalized;
    }
    return [];
}

function normalizeMarketCapCsvRows(rows) {
    const out = [];
    rows.forEach(r => {
        const date = parseReportDate(r.date);
        if (!date) return;
        const raw = r.mkt_cap_billion_cny ?? r.market_cap_billion_cny ?? r.market_cap ?? r.mkt_cap;
        const cap = normalizeMarketCapValue(raw);
        if (cap === null) return;
        out.push({ date, cap });
    });
    return out;
}

async function loadMarketCapFromCsv(symbol) {
    try {
        const res = await fetch(`outputs/${symbol}_mkt_cap_10y.csv`);
        if (!res.ok) return [];
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true });
        return normalizeMarketCapCsvRows(parsed.data || []);
    } catch (err) {
        return [];
    }
}

function buildWideRows(records) {
    const byDate = new Map();
    records.forEach(rec => {
        const reportType = rec.report_type ? String(rec.report_type).toLowerCase() : '';
        if (reportType.includes('ltm')) return;
        const account = rec.account;
        const key = accountMapping[account];
        if (!key) return;
        const date = parseReportDate(rec.report_date);
        if (!date) return;
        if (!byDate.has(date)) byDate.set(date, { report_date: date, _updated: {} });
        const row = byDate.get(date);
        const existingUpdated = row._updated[key];
        const updatedAt = rec.updated_at || '';
        if (!existingUpdated || String(updatedAt) >= String(existingUpdated)) {
            row[key] = rec.value !== null && rec.value !== undefined ? Number(rec.value) : null;
            row._updated[key] = updatedAt;
        }
    });
    const rows = Array.from(byDate.values())
        .sort((a, b) => new Date(a.report_date) - new Date(b.report_date));
    rows.forEach(r => delete r._updated);
    return rows;
}

function computeLtmRows(rows) {
    const flowCols = Object.values(accountMapping).filter(c => !statusCols.includes(c));
    const map = new Map(rows.map(r => [r.report_date, r]));
    return rows.map(row => {
        const d = new Date(row.report_date);
        const year = d.getFullYear();
        const month = d.getMonth() + 1;
        const day = d.getDate();
        if (month === 12 && day === 31) return { ...row };
        const priorYearEndKey = `${year - 1}-12-31`;
        const priorSameKey = `${year - 1}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const priorYearEnd = map.get(priorYearEndKey);
        const priorSame = map.get(priorSameKey);
        const out = { ...row };
        flowCols.forEach(col => {
            const curr = Number(row[col] || 0);
            if (priorYearEnd && priorSame) {
                out[col] = curr + Number(priorYearEnd[col] || 0) - Number(priorSame[col] || 0);
            } else {
                out[col] = null;
            }
        });
        return out;
    });
}

function ffill(rows, col) {
    let last = null;
    rows.forEach(r => {
        if (r[col] !== null && r[col] !== undefined && !isNaN(r[col])) {
            last = r[col];
        } else if (last !== null) {
            r[col] = last;
        }
    });
}

function calculateDerived(rows) {
    rows.forEach(r => {
        if (!r) return;
        const get = (k) => (r[k] !== null && r[k] !== undefined && !isNaN(r[k])) ? Number(r[k]) : 0;
        const setIfMissing = (k, v = 0) => {
            if (r[k] === null || r[k] === undefined || isNaN(r[k])) r[k] = v;
        };

        // Basic fills
        ['Total_Equity','Total_Assets','Total_Liabilities','Total_Current_Assets','Total_Current_Liabilities'].forEach(c => setIfMissing(c, null));
    });

    ['Total_Equity','Total_Assets','Total_Liabilities','Total_Current_Assets','Total_Current_Liabilities'].forEach(c => ffill(rows, c));

    rows.forEach((r, idx) => {
        const prev = idx > 0 ? rows[idx - 1] : null;
        const get = (k) => (r[k] !== null && r[k] !== undefined && !isNaN(r[k])) ? Number(r[k]) : 0;
        const getPrev = (k) => (prev && prev[k] !== null && prev[k] !== undefined && !isNaN(prev[k])) ? Number(prev[k]) : 0;

        // Debt & Cash
        r.Total_Debt = get('Short_Term_Debt') + get('Current_Portion_LT_Debt') + get('Long_Term_Debt') + get('Bonds_Payable');
        r.Total_Cash = get('Cash_Equivalents') + get('Short_Term_Investments');
        r.Net_Debt = r.Total_Debt - r.Total_Cash;

        const marketCapVal = (r.Market_Cap !== null && r.Market_Cap !== undefined && !isNaN(r.Market_Cap) && Number(r.Market_Cap) > 0)
            ? Number(r.Market_Cap)
            : null;

        // Enterprise Value (avoid negative from missing Market Cap)
        r.EV = marketCapVal !== null
            ? marketCapVal + r.Total_Debt - r.Total_Cash + get('Minority_Interest')
            : null;

        // Income Statement metrics
        r.Other_Revenue = get('Other_Business_Revenue');
        r.Main_Revenue = get('Revenue') - r.Other_Revenue;
        r.Gross_Profit = get('Revenue') - get('COGS');
        r.SGA_Exp = get('Selling_Exp') + get('Admin_Exp');
        r.Operating_Expenses = get('Selling_Exp') + get('Admin_Exp') + get('RD_Exp');
        r.Other_Operating_Exp = get('Taxes_Surcharges');
        r.EBIT = r.Gross_Profit - get('Selling_Exp') - get('Admin_Exp') - get('RD_Exp');
        r.DA_Estimated = get('Revenue') * 0.015;
        r.EBITDA = r.EBIT + r.DA_Estimated;
        r.Net_Interest_Exp = get('Fin_Exp') * -1;
        r.Interest_And_Investment_Income = get('Interest_Inc') + get('Investment_Income');
        r.Non_Operating_Net = get('Non_Operating_Income') - get('Non_Operating_Exp');
        r.Gain_On_Asset_Sale = get('Asset_Disposal_Gain') + get('NonCurrent_Asset_Disposal_Gain') - get('NonCurrent_Asset_Disposal_Loss');
        r.Gain_On_Investment_Sale = get('Investment_Income');
        r.Total_Impairment = get('Asset_Impairment') + get('Credit_Impairment');
        r.Other_Unusual_Items = get('Other_Income') + get('FV_Change_Income');
        r.EBT_Excl_Unusual = r.EBIT + r.Net_Interest_Exp;
        r.EBT_Incl_Unusual = get('Pretax_Income');
        r.Earnings_Continuing = get('Net_Income');
        r.Net_Income_Common = get('Net_Income_Parent') || get('Net_Income');

        // Margins
        const revSafe = get('Revenue') || null;
        r.Gross_Margin = revSafe ? r.Gross_Profit / revSafe : null;
        r.Operating_Margin = revSafe ? get('Operating_Income') / revSafe : null;
        r.EBITDA_Margin = revSafe ? r.EBITDA / revSafe : null;
        r.EBIT_Margin = revSafe ? r.EBIT / revSafe : null;
        r.EBT_Margin = revSafe ? get('Pretax_Income') / revSafe : null;
        r.EBT_Excl_Unusual_Margin = revSafe ? r.EBT_Excl_Unusual / revSafe : null;
        r.SGA_Margin = revSafe ? r.SGA_Exp / revSafe : null;
        r.Net_Margin = revSafe ? get('Net_Income') / revSafe : null;
        r.Net_Avail_Common_Margin = revSafe ? r.Net_Income_Common / revSafe : null;
        r.Normalized_Net_Income = get('Net_Income') - r.Total_Impairment - r.Other_Unusual_Items - r.Gain_On_Asset_Sale;
        r.Normalized_Net_Income_Margin = revSafe ? r.Normalized_Net_Income / revSafe : null;

        // Working Capital
        r.Working_Capital = get('Total_Current_Assets') - get('Total_Current_Liabilities');
        r.Working_Capital_Change = r.Working_Capital - (prev ? (getPrev('Working_Capital') || 0) : 0);

        // Changes in components
        r.AR_Total = (get('Accounts_Receivable') || get('Notes_AR_Combined'));
        r.AP_Total = (get('Accounts_Payable') || get('Notes_AP_Combined'));
        r.Change_In_AR = -(r.AR_Total - (prev ? getPrev('AR_Total') : 0));
        r.Change_In_Inventory = -(get('Inventory') - (prev ? getPrev('Inventory') : 0));
        r.Change_In_AP = (r.AP_Total - (prev ? getPrev('AP_Total') : 0));
        r.Change_In_Prepaid = -(get('Prepaid_Expenses') - (prev ? getPrev('Prepaid_Expenses') : 0));
        r.Change_In_Other_Receivables = -(get('Other_Receivables') - (prev ? getPrev('Other_Receivables') : 0));
        r.Change_In_Other_Payables = (get('Other_Payables') - (prev ? getPrev('Other_Payables') : 0));
        r.Change_In_Unearned = (get('Unearned_Revenue') + get('Contract_Liabilities')) - (prev ? (getPrev('Unearned_Revenue') + getPrev('Contract_Liabilities')) : 0);

        // Balance Sheet derived
        r.Total_Receivables = (get('Accounts_Receivable') + get('Notes_Receivable') + get('Financing_Receivables')) || get('Notes_AR_Combined');
        r.CIP = get('Construction_In_Progress_Total') || get('Construction_In_Progress');
        r.Total_PPE_Koyfin = get('Net_PPE') + r.CIP;
        r.Unearned_Revenue_Total = get('Unearned_Revenue') + get('Contract_Liabilities');
        r.Unearned_Revenue_NonCurrent = get('LT_Deferred_Revenue');
        r.Other_Receivables_Final = get('Other_Receivables_Total') || get('Other_Receivables');
        r.Common_Equity = get('Equity_Parent') || (get('Total_Equity') - get('Minority_Interest'));
        r.Total_Capital = get('Total_Equity') + r.Total_Debt;
        r.Tangible_Book_Value = get('Total_Equity') - get('Goodwill') - get('Intangible_Assets');

        // Shares
        r.Shares_Outstanding = get('EPS') ? (get('Net_Income') / get('EPS')) : null;
        r.Book_Value_Per_Share = r.Shares_Outstanding ? (get('Total_Equity') / r.Shares_Outstanding) : null;
        r.Tangible_BV_Per_Share = r.Shares_Outstanding ? (r.Tangible_Book_Value / r.Shares_Outstanding) : null;

        // Returns
        r.ROE = get('Total_Equity') ? (get('Net_Income') / get('Total_Equity')) : null;
        r.ROA = get('Total_Assets') ? (get('Net_Income') / get('Total_Assets')) : null;
        r.Return_On_Capital = r.Total_Capital ? (get('Net_Income') / r.Total_Capital) : null;
        r.Return_On_Common_Equity = r.Common_Equity ? (r.Net_Income_Common / r.Common_Equity) : null;

        // ROIC
        r.NOPAT = r.EBIT - get('Income_Tax_Exp');
        r.Invested_Capital = r.Total_Debt + get('Total_Equity') + get('Lease_Liabilities');
        r.Avg_Invested_Capital = (r.Invested_Capital + (prev ? getPrev('Invested_Capital') : 0)) / 2;
        r.ROIC = r.Avg_Invested_Capital ? (r.NOPAT / r.Avg_Invested_Capital) : null;

        // Multiples
        r.PE = (marketCapVal && get('Net_Income')) ? (marketCapVal / get('Net_Income')) : null;
        r.PS = (marketCapVal && get('Revenue')) ? (marketCapVal / get('Revenue')) : null;
        r.PB = (marketCapVal && get('Total_Equity')) ? (marketCapVal / get('Total_Equity')) : null;
        r.P_TangibleBV = (marketCapVal && r.Tangible_Book_Value) ? (marketCapVal / r.Tangible_Book_Value) : null;
        r.EV_Sales = get('Revenue') ? (r.EV / get('Revenue')) : null;
        r.EV_EBITDA = r.EBITDA ? (r.EV / r.EBITDA) : null;
        r.EV_EBIT = r.EBIT ? (r.EV / r.EBIT) : null;

        // Cash flow
        r.Total_PPE = get('Net_PPE') + get('Construction_In_Progress');
        r.DA_From_Accum = get('Accumulated_Depreciation') - (prev ? getPrev('Accumulated_Depreciation') : 0);
        r.DA_From_PPE = (prev ? getPrev('Total_PPE') : 0) + Math.abs(get('CapEx')) - r.Total_PPE;
        r.DA = r.DA_From_Accum > 0 ? r.DA_From_Accum : r.DA_From_PPE;
        r.DA = (r.DA !== null && r.DA > 0) ? r.DA : r.DA_Estimated;
        r.Depreciation = r.DA_From_Accum > 0 ? r.DA_From_Accum : 0;
        r.Amortization = Math.max(0, r.DA - r.Depreciation);
        r.EBITA = r.EBIT + r.Amortization;
        r.EBITA_Margin = revSafe ? (r.EBITA / revSafe) : null;
        r.EBITDA = r.EBIT + r.DA;
        r.FCF = get('OCF') - Math.abs(get('CapEx'));
        r.FCF_Per_Share = r.Shares_Outstanding ? (r.FCF / r.Shares_Outstanding) : null;
        r.FCF_Yield = marketCapVal ? (r.FCF / marketCapVal) : null;
        r.EV_OCF = get('OCF') ? (r.EV / get('OCF')) : null;
        r.Total_Debt_Issued = get('Proceeds_From_Borrowings') + get('Bond_Issuance');
        r.Total_Debt_Repaid = get('Repayment_Of_Debt');
        r.Net_Debt_Issued = r.Total_Debt_Issued - Math.abs(r.Total_Debt_Repaid);
        r.Common_Dividends_Paid = get('Dividends_Paid') - Math.abs(get('Minority_Dividends_Paid'));
        r.Other_Operating_Activities = get('Other_Operating_Cash_In') - Math.abs(get('Other_Operating_Cash_Out'));
        r.Other_Investing_Activities = get('Other_Investing_Cash_In') - Math.abs(get('Other_Investing_Cash_Out'));
        r.Other_Financing_Activities = get('Other_Financing_Cash_In') - Math.abs(get('Other_Financing_Cash_Out'));
        r.Investment_In_Securities = get('Cash_For_Investments') - get('Proceeds_From_Investment_Sales');

        // Solvency
        r.Debt_to_Equity = get('Total_Equity') ? (r.Total_Debt / get('Total_Equity')) : null;
        r.Debt_to_Capital = r.Total_Capital ? (r.Total_Debt / r.Total_Capital) : null;
        r.LT_Debt_to_Equity = get('Total_Equity') ? (get('Long_Term_Debt') / get('Total_Equity')) : null;
        r.LT_Debt_to_Capital = r.Total_Capital ? (get('Long_Term_Debt') / r.Total_Capital) : null;
        r.Liabilities_to_Assets = get('Total_Assets') ? (get('Total_Liabilities') / get('Total_Assets')) : null;
        r.Interest_Coverage_EBIT = get('Interest_Exp') ? (r.EBIT / get('Interest_Exp')) : null;
        r.Interest_Coverage_EBITDA = get('Interest_Exp') ? (r.EBITDA / get('Interest_Exp')) : null;
        r.Interest_Coverage_EBITDA_CapEx = get('Interest_Exp') ? ((r.EBITDA - Math.abs(get('CapEx'))) / get('Interest_Exp')) : null;
        r.Debt_to_EBITDA = r.EBITDA ? (r.Total_Debt / r.EBITDA) : null;
        r.Net_Debt_to_EBITDA = r.EBITDA ? (r.Net_Debt / r.EBITDA) : null;
        r.Current_Ratio = get('Total_Current_Liabilities') ? (get('Total_Current_Assets') / get('Total_Current_Liabilities')) : null;
        r.Quick_Ratio = get('Total_Current_Liabilities') ? ((get('Total_Current_Assets') - get('Inventory')) / get('Total_Current_Liabilities')) : null;
        r.Operating_Cash_Flow_to_Current_Liabilities = get('Total_Current_Liabilities') ? (get('OCF') / get('Total_Current_Liabilities')) : null;

        // Altman Z-Score (Z'')
        const X1 = get('Total_Assets') ? (r.Working_Capital / get('Total_Assets')) : null;
        const X2 = get('Total_Assets') ? (get('Retained_Earnings') / get('Total_Assets')) : null;
        const X3 = get('Total_Assets') ? (r.EBIT / get('Total_Assets')) : null;
        const X4 = get('Total_Liabilities') ? (get('Total_Equity') / get('Total_Liabilities')) : null;
        r.Altman_Z_Score = (X1 !== null && X2 !== null && X3 !== null && X4 !== null) ?
            (6.56 * X1 + 3.26 * X2 + 6.72 * X3 + 1.05 * X4) : null;

        // Turnovers
        const avgReceivables = (r.Total_Receivables + (prev ? getPrev('Total_Receivables') : r.Total_Receivables)) / 2;
        const avgInventory = (get('Inventory') + (prev ? getPrev('Inventory') : get('Inventory'))) / 2;
        const avgAssets = (get('Total_Assets') + (prev ? getPrev('Total_Assets') : get('Total_Assets'))) / 2;
        const avgFixed = (r.Total_PPE_Koyfin + (prev ? getPrev('Total_PPE_Koyfin') : r.Total_PPE_Koyfin)) / 2;
        const avgPayables = (r.AP_Total + (prev ? getPrev('AP_Total') : r.AP_Total)) / 2;
        r.Receivables_Turnover = avgReceivables ? (get('Revenue') / avgReceivables) : null;
        r.Fixed_Assets_Turnover = avgFixed ? (get('Revenue') / avgFixed) : null;
        r.Inventory_Turnover = avgInventory ? (get('COGS') / avgInventory) : null;
        r.Asset_Turnover = avgAssets ? (get('Revenue') / avgAssets) : null;
        r.Days_Outstanding_Inventory = r.Inventory_Turnover ? (365 / r.Inventory_Turnover) : null;
        r.Days_Sales_Outstanding = r.Receivables_Turnover ? (365 / r.Receivables_Turnover) : null;
        r.Days_Payable_Outstanding = avgPayables ? (365 / (get('COGS') / avgPayables)) : null;
        r.Cash_Conversion_Cycle = (r.Days_Sales_Outstanding || 0) + (r.Days_Outstanding_Inventory || 0) - (r.Days_Payable_Outstanding || 0);
    });

    return rows;
}

function addYoY(rows, isLtm) {
    const periods = isLtm ? 4 : 1;
    rows.forEach((r, idx) => {
        const prev = rows[idx - periods];
        const pct = (curr, prevVal) => (prevVal ? (curr - prevVal) / prevVal : null);
        if (prev) {
            r.Rev_YoY = pct(r.Revenue, prev.Revenue);
            r.Gross_Profit_YoY = pct(r.Gross_Profit, prev.Gross_Profit);
            r.EBITDA_YoY = pct(r.EBITDA, prev.EBITDA);
            r.NetInc_YoY = pct(r.Net_Income, prev.Net_Income);
            r.EPS_YoY = pct(r.EPS, prev.EPS);
            r.OCF_YoY = pct(r.OCF, prev.OCF);
            r.CapEx_YoY = pct(r.CapEx, prev.CapEx);
        }
    });
    return rows;
}

function attachMarketCap(rows, marketCaps) {
    if (!marketCaps || marketCaps.length === 0) return rows;
    const caps = marketCaps
        .filter(r => r.date && isFinite(r.cap))
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    let i = 0;
    rows.forEach(row => {
        const date = new Date(row.report_date);
        while (i + 1 < caps.length && new Date(caps[i + 1].date) <= date) i += 1;
        row.Market_Cap = caps[i] ? caps[i].cap : null;
    });
    return rows;
}

async function loadDataFromSupabase(symbol) {
    const container = document.getElementById('table-box');
    container.innerHTML = '<div class="loading">Loading data...</div>';

    const cached = dataCache.get(symbol);
    if (cached) {
        return cached;
    }

    const records = await fetchAllFinancials(symbol);
    let marketCaps = await fetchMarketCapHistory(symbol);
    if (!marketCaps.length) {
        marketCaps = await loadMarketCapFromCsv(symbol);
    }
    let rows = buildWideRows(records);
    rows = attachMarketCap(rows, marketCaps);

    const annual = rows.filter(r => r.report_date && r.report_date.endsWith('-12-31'));
    const ltm = computeLtmRows(rows);

    const result = {
        annual: addYoY(calculateDerived(annual), false),
        ltm: addYoY(calculateDerived(ltm), true)
    };
    dataCache.set(symbol, result);

    console.log(`Loaded LTM: ${result.ltm.length} rows, Annual: ${result.annual.length} rows`);
    return result;
}

async function loadData() {
    try {
        console.log("Loading data from Supabase...");
        await setupCompanySearch();
        const symbol = normalizeSymbol(document.getElementById('company-search-input').value);
        const result = await loadDataFromSupabase(symbol);
        rawData.annual = result.annual;
        rawData.ltm = result.ltm;
        
        // 加载股东数据
        holdersData = await fetchHoldersData(symbol);
        holdersDataLoaded = true;
        console.log(`Loaded holders data: ${holdersData.length} rows`);
        
        // 加载 TOP 10 股东数据
        top10ShareholdersData = await fetchTop10ShareholdersData(symbol);
        top10DataLoaded = true;
        console.log(`Loaded top10 shareholders data: ${top10ShareholdersData.length} rows`);
        
        render();
        runValidationChecks();
    } catch (err) {
        console.error("Error loading data:", err);
        document.getElementById('table-box').innerHTML = `
            <div class="loading" style="color:red; text-align:left; padding:20px;">
                <strong>Error loading data:</strong><br><br>
                ${err.message}<br><br>
                <small>Please ensure:<br>
                1. You are viewing this page through http://localhost:8000/<br>
                2. Supabase is reachable<br>
                3. Your browser console (F12) for more details</small>
            </div>`;
    }
}

async function runValidationChecks() {
    if (!VALIDATION_MODE) return;
    const validationKeys = ['Revenue', 'OCF', 'Total_Assets', 'EV', 'ROIC'];
    const latestAnnual = [...rawData.annual].sort((a, b) => new Date(b.report_date) - new Date(a.report_date))[0];
    const latestLtm = [...rawData.ltm].sort((a, b) => new Date(b.report_date) - new Date(a.report_date))[0];
    if (!latestAnnual || !latestLtm) return;

    const loadCsv = async (path) => {
        const res = await fetch(path);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true });
        return parsed.data || [];
    };

    try {
        const annualCsv = await loadCsv('outputs/002508_analysis/annual_metrics.csv');
        const ltmCsv = await loadCsv('outputs/002508_analysis/ltm_metrics.csv');
        const annualRow = annualCsv.find(r => parseReportDate(r.report_date) === latestAnnual.report_date);
        const ltmRow = ltmCsv.find(r => parseReportDate(r.report_date) === latestLtm.report_date);
        if (!annualRow || !ltmRow) return;

        const compare = (label, row, csvRow) => {
            const table = validationKeys.map(key => {
                const supaVal = Number(row[key]);
                const csvVal = Number(csvRow[key]);
                const diffPct = (csvVal && !isNaN(csvVal)) ? ((supaVal - csvVal) / csvVal) * 100 : null;
                return { metric: key, supabase: supaVal, csv: csvVal, diffPct };
            });
            console.group(`Validation ${label} (${row.report_date})`);
            console.table(table);
            console.groupEnd();
        };

        compare('Annual', latestAnnual, annualRow);
        compare('LTM', latestLtm, ltmRow);
    } catch (err) {
        console.warn('Validation failed:', err);
    }
}

async function setupCompanySearch() {
    try {
        const input = document.getElementById('company-search-input');
        input.addEventListener('input', () => handleCompanyInput(input.value));
        input.addEventListener('change', async () => {
            updateCompanyInfo(input.value);
            const symbol = normalizeSymbol(input.value);
            const result = await loadDataFromSupabase(symbol);
            rawData.annual = result.annual;
            rawData.ltm = result.ltm;
            
            // 重新加载股东数据
            holdersData = await fetchHoldersData(symbol);
            holdersDataLoaded = true;
            
            // 重新加载 TOP 10 股东数据
            top10ShareholdersData = await fetchTop10ShareholdersData(symbol);
            top10DataLoaded = true;
            
            render();
        });
        input.addEventListener('blur', () => updateCompanyInfo(input.value));
        companyLookupLoaded = true;
        handleCompanyInput(input.value);
    } catch (err) {
        console.warn('Failed to setup company search:', err);
        companyLookupLoaded = false;
    }
}

function handleCompanyInput(val) {
    if (companySearchTimer) clearTimeout(companySearchTimer);
    companySearchTimer = setTimeout(async () => {
        await fetchCompanySuggestions(val);
        await updateCompanyInfo(val);
    }, 250);
}

async function fetchCompanySuggestions(query) {
    const q = normalizeSymbol(query);
    const datalist = document.getElementById('company-symbols');
    datalist.innerHTML = '';
    if (!q) return;

    try {
        const { data, error } = await supabaseClient
            .from('company_list')
            .select('symbol,market')
            .eq('market', 'cn')
            .ilike('symbol', `%${q}%`)
            .limit(20);
        if (error) {
            console.warn('Company list query failed', error.message);
            return;
        }
        companySuggestions = data || [];
        companySuggestions.forEach(r => {
            const option = document.createElement('option');
            option.value = String(r.symbol || '').toUpperCase();
            datalist.appendChild(option);
        });
    } catch (err) {
        console.warn('Company suggestion error', err);
    }
}

function setView(view, btn) {
    currentView = view;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
}

function setTab(tab, el) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    render();
}

function toggleSection(sectionId) {
    collapsedSections[sectionId] = !collapsedSections[sectionId];
    render();
}

function formatVal(val, format, metricKey) {
    if (val === null || val === undefined || isNaN(val)) return '-';
    
    const isNegative = val < 0;
    const absVal = Math.abs(val);
    
    if (format === 'pct') {
        const pctVal = (val * 100).toFixed(1) + '%';
        if (isNegative) return `<span class="val-negative">(${(absVal * 100).toFixed(1)}%)</span>`;
        return `<span class="val-positive">${pctVal}</span>`;
    }
    
    if (format === 'ratio') {
        const ratioVal = val.toFixed(1) + 'x';
        if (isNegative) return `(${absVal.toFixed(1)}x)`;
        return ratioVal;
    }
    
    if (format === 'decimal') {
        return val.toFixed(1);
    }
    
    // Default: monetary value with M suffix
    let formatted;
    if (absVal >= 1e9) {
        formatted = (absVal / 1e6).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + 'M';
    } else if (absVal >= 1e6) {
        formatted = (absVal / 1e6).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + 'M';
    } else if (absVal >= 1e3) {
        formatted = (absVal / 1e6).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + 'M';
    } else {
        formatted = absVal.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    }
    
    if (isNegative) return `<span class="val-negative">(${formatted})</span>`;
    return formatted;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (currentView === 'ltm') {
        const month = d.getMonth() + 1;
        const quarter = Math.ceil(month / 3);
        return `${quarter}Q CY${d.getFullYear()}`;
    }
    return `CY ${d.getFullYear()}`;
}

function normalizeSymbol(input) {
    if (!input) return '';
    let s = String(input).trim().toUpperCase();
    s = s.replace(/\\s+/g, '');
    s = s.replace(/\\.SZ$|\\.SH$|\\.SS$/i, '');
    return s;
}

function formatNumber(val, decimals = 2) {
    if (val === null || val === undefined || isNaN(val)) return '-';
    return Number(val).toFixed(decimals);
}

function formatPercent(val, decimals = 1) {
    if (val === null || val === undefined || isNaN(val)) return '-';
    return `${Number(val).toFixed(decimals)}%`;
}

async function updateCompanyInfo(inputVal) {
    const symbol = normalizeSymbol(inputVal);
    const infoEl = document.getElementById('company-info');
    if (!companyLookupLoaded) {
        infoEl.innerHTML = `
            <div class="company-info-row">
                <span class="info-item">公司：加载中或失败</span>
                <span class="info-item">Sector：-</span>
                <span class="info-item">Industry：-</span>
                <span class="info-item">Market：-</span>
            </div>
            <div class="company-info-row">
                <span class="info-item">EV：-</span>
                <span class="info-item">Market Cap：-</span>
                <span class="info-item">Beta 5Y：-</span>
                <span class="info-item">Beta 1Y：-</span>
                <span class="info-item">OCF/EV：-</span>
                <span class="info-item">GAP：-</span>
                <span class="info-item">Date：-</span>
            </div>
        `;
        return;
    }
    if (!symbol) {
        infoEl.innerHTML = `
            <div class="company-info-row">
                <span class="info-item">公司：-</span>
                <span class="info-item">Sector：-</span>
                <span class="info-item">Industry：-</span>
                <span class="info-item">Market：-</span>
            </div>
            <div class="company-info-row">
                <span class="info-item">EV：-</span>
                <span class="info-item">Market Cap：-</span>
                <span class="info-item">Beta 5Y：-</span>
                <span class="info-item">Beta 1Y：-</span>
                <span class="info-item">OCF/EV：-</span>
                <span class="info-item">GAP：-</span>
                <span class="info-item">Date：-</span>
            </div>
        `;
        return;
    }

    let company = null;
    let market = null;

    try {
        const { data: companyRows, error: companyErr } = await supabaseClient
            .from('company_list')
            .select('symbol,market,description,sector,industry,exchange')
            .eq('symbol', symbol)
            .eq('market', 'cn')
            .limit(1);
        if (companyErr) {
            console.warn('Company lookup error', companyErr.message);
        } else {
            company = companyRows && companyRows[0];
        }

        const { data: marketRows, error: marketErr } = await supabaseClient
            .from('share_a_market')
            .select('symbol,enterprise_value,market_capitalization,beta_5_years,beta_1_year,cash_from_operating_activities_trailing_12_months,"return_on_invested_capital_%_trailing_12_months",download_date')
            .eq('symbol', symbol)
            .order('download_date', { ascending: false })
            .limit(1);
        if (marketErr) {
            console.warn('Market lookup error', marketErr.message);
        } else {
            market = marketRows && marketRows[0];
        }
    } catch (err) {
        console.warn('Company lookup error', err);
    }

    if (!company && !market) {
        infoEl.innerHTML = `
            <div class="company-info-row">
                <span class="info-item">公司：-</span>
                <span class="info-item">Sector：-</span>
                <span class="info-item">Industry：-</span>
                <span class="info-item">Market：-</span>
            </div>
            <div class="company-info-row">
                <span class="info-item">EV：-</span>
                <span class="info-item">Market Cap：-</span>
                <span class="info-item">Beta 5Y：-</span>
                <span class="info-item">Beta 1Y：-</span>
                <span class="info-item">OCF/EV：-</span>
                <span class="info-item">GAP：-</span>
                <span class="info-item">Date：-</span>
            </div>
        `;
        return;
    }

    const ev = market ? market.enterprise_value : null;
    const mcap = market ? market.market_capitalization : null;
    const beta5 = market ? market.beta_5_years : null;
    const beta1 = market ? market.beta_1_year : null;
    const ocf = market ? market.cash_from_operating_activities_trailing_12_months : null;
    const roicRaw = market ? market["return_on_invested_capital_%_trailing_12_months"] : null;
    const roicPct = (roicRaw !== null && roicRaw !== undefined)
        ? (Math.abs(roicRaw) <= 1 ? roicRaw * 100 : roicRaw)
        : null;
    const ocfEvPct = (ocf && ev) ? (ocf / ev) * 100 : null;
    const gapPct = (ocf && roicPct !== null && ev) ? (ev / ((roicPct + 5) * ocf)) * 100 : null;

    infoEl.innerHTML = `
        <div class="company-info-row">
            <span class="info-item">公司：${(company && company.description) || '-'}</span>
            <span class="info-item">Sector：${(company && company.sector) || '-'}</span>
            <span class="info-item">Industry：${(company && company.industry) || '-'}</span>
            <span class="info-item">Market：${(company && company.market) || '-'}</span>
        </div>
        <div class="company-info-row">
            <span class="info-item">EV：${formatVal(ev)}</span>
            <span class="info-item">Market Cap：${formatVal(mcap)}</span>
            <span class="info-item">Beta 5Y：${formatNumber(beta5)}</span>
            <span class="info-item">Beta 1Y：${formatNumber(beta1)}</span>
            <span class="info-item">OCF/EV：${formatPercent(ocfEvPct, 1)}</span>
            <span class="info-item">GAP：${formatPercent(gapPct, 0)}</span>
            <span class="info-item">Date：${(market && market.download_date) || '-'}</span>
        </div>
    `;
}

function render() {
    // 如果是 Holders 标签页，使用特殊渲染
    if (currentTab === 'Holders') {
        renderHolders();
        return;
    }
    
    // 如果是 Top10Shareholders 标签页，使用特殊渲染
    if (currentTab === 'Top10Shareholders') {
        renderTop10Shareholders();
        return;
    }
    
    const data = [...rawData[currentView]].sort((a, b) => new Date(a.report_date) - new Date(b.report_date));
    const sections = tabConfigs[currentTab];
    const container = document.getElementById('table-box');
    
    if (!data.length) {
        container.innerHTML = '<div class="loading">No data available</div>';
        return;
    }
    
    let html = '<table><thead><tr><th></th>';
    data.forEach(row => html += `<th>${formatDate(row.report_date)}</th>`);
    html += '</tr></thead><tbody>';

    Object.entries(sections).forEach(([sectionName, metrics]) => {
        const sectionId = `${currentTab}_${sectionName}`.replace(/\s/g, '_');
        const isCollapsed = collapsedSections[sectionId];
        const icon = isCollapsed ? '▶' : '▼';
        
        // Section header row
        html += `<tr class="section-header" onclick="toggleSection('${sectionId}')">
            <td><span class="toggle-icon">${icon}</span>${sectionName}</td>`;
        data.forEach(() => html += '<td></td>');
        html += '</tr>';
        
        // Metric rows
        metrics.forEach(m => {
            const classes = [];
            if (isCollapsed) classes.push('row-hidden');
            if (m.indent === 1) classes.push('indent-1');
            if (m.indent === 2) classes.push('indent-2');
            if (m.indent === 3) classes.push('indent-3');
            if (m.bold) classes.push('metric-bold');
            
            html += `<tr class="${classes.join(' ')}"><td>${m.label}</td>`;
            data.forEach(row => {
                const val = row[m.key];
                html += `<td>${formatVal(val, m.format, m.key)}</td>`;
            });
            html += '</tr>';
        });
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function formatHolderVal(val, format) {
    if (val === null || val === undefined || isNaN(val)) return '-';
    
    if (format === 'integer') {
        return Math.round(val).toLocaleString();
    }
    if (format === 'decimal') {
        return Number(val).toFixed(2);
    }
    if (format === 'pct_signed') {
        const pctVal = Number(val).toFixed(1);
        if (val > 0) return `<span class="val-positive">${pctVal}%</span>`;
        if (val < 0) return `<span class="val-negative">${pctVal}%</span>`;
        return `${pctVal}%`;
    }
    return String(val);
}

function getHolderCellClass(val, format) {
    if (val === null || val === undefined || isNaN(val)) return '';
    if (format === 'pct_signed') {
        if (val > 10) return 'holder-strong-positive';
        if (val > 0) return 'holder-positive';
        if (val < -10) return 'holder-strong-negative';
        if (val < 0) return 'holder-negative';
    }
    return '';
}

function renderHolders() {
    const container = document.getElementById('table-box');
    
    if (!holdersDataLoaded || !holdersData.length) {
        container.innerHTML = '<div class="loading">股东数据加载中或无数据...</div>';
        return;
    }
    
    // 按日期倒序排列（最新在左边）
    const data = [...holdersData].sort((a, b) => new Date(b.report_date) - new Date(a.report_date));
    
    // 计算派生指标
    const processedData = data.map((row, idx) => {
        const prev = data[idx + 1]; // 前一期（因为是倒序）
        const holderCount = Number(row.current_holder_count) || 0;
        const prevHolderCount = prev ? Number(prev.current_holder_count) : null;
        const avgShares = Number(row.current_avg_shares) || 0;
        const prevAvgShares = prev ? Number(prev.current_avg_shares) : null;
        
        // 从财务数据获取市值（如果可用）
        const reportDate = row.report_date;
        const financialRow = rawData.annual.find(r => r.report_date === reportDate) || 
                            rawData.ltm.find(r => r.report_date === reportDate);
        const marketCap = financialRow ? financialRow.Market_Cap : null;
        const marketCapBillion = marketCap ? marketCap / 1e8 : null; // 转换为亿元
        
        // 计算市值变化率
        const prevFinancialRow = prev ? (rawData.annual.find(r => r.report_date === prev.report_date) || 
                                         rawData.ltm.find(r => r.report_date === prev.report_date)) : null;
        const prevMarketCap = prevFinancialRow ? prevFinancialRow.Market_Cap : null;
        const marketCapChangePct = (marketCap && prevMarketCap) ? 
            ((marketCap - prevMarketCap) / prevMarketCap) * 100 : null;
        
        // 户均持股金额（万元）= 总市值 / 股东人数 / 10000
        const avgAmountPerHolder = (marketCap && holderCount) ? 
            (marketCap / holderCount) / 10000 : null;
        const prevAvgAmount = (prevMarketCap && prevHolderCount) ?
            (prevMarketCap / prevHolderCount) / 10000 : null;
        const avgAmountChangePct = (avgAmountPerHolder && prevAvgAmount) ?
            ((avgAmountPerHolder - prevAvgAmount) / prevAvgAmount) * 100 : null;
        
        return {
            report_date: reportDate,
            holder_count: holderCount,
            holder_count_change_pct: Number(row.holder_count_change_pct) || null,
            Market_Cap_Billion: marketCapBillion,
            market_cap_change_pct: marketCapChangePct,
            relative_strength: null, // 需要上证指数数据
            avg_shares_per_holder: avgAmountPerHolder,
            avg_shares_change_pct: avgAmountChangePct || Number(row.avg_shares_change_pct) || null,
            sh_index: null, // 需要上证指数数据
            sh_index_change_pct: null
        };
    });
    
    const sections = tabConfigs['Holders'];
    
    // 格式化日期显示
    const formatHolderDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const year = d.getFullYear();
        const month = d.getMonth() + 1;
        const day = d.getDate();
        return `${year}/${month}/${day}`;
    };
    
    let html = `
        <style>
            .holder-strong-positive { background-color: #c8e6c9 !important; }
            .holder-positive { background-color: #e8f5e9 !important; }
            .holder-strong-negative { background-color: #ffcdd2 !important; }
            .holder-negative { background-color: #ffebee !important; }
            .holders-charts-container { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
            .holders-chart { padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: #fff; }
            .holders-chart .chart-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 10px; }
            .holders-chart canvas { width: 100%; height: 280px; }
        </style>
        <table><thead><tr><th></th>`;
    
    processedData.forEach(row => html += `<th>${formatHolderDate(row.report_date)}</th>`);
    html += '</tr></thead><tbody>';

    Object.entries(sections).forEach(([sectionName, metrics]) => {
        const sectionId = `Holders_${sectionName}`.replace(/\s/g, '_');
        const isCollapsed = collapsedSections[sectionId];
        const icon = isCollapsed ? '▶' : '▼';
        
        html += `<tr class="section-header" onclick="toggleSection('${sectionId}')">
            <td><span class="toggle-icon">${icon}</span>${sectionName}</td>`;
        processedData.forEach(() => html += '<td></td>');
        html += '</tr>';
        
        metrics.forEach(m => {
            const classes = [];
            if (isCollapsed) classes.push('row-hidden');
            if (m.indent === 1) classes.push('indent-1');
            if (m.bold) classes.push('metric-bold');
            
            html += `<tr class="${classes.join(' ')}"><td>${m.label}</td>`;
            processedData.forEach(row => {
                const val = row[m.key];
                const cellClass = getHolderCellClass(val, m.format);
                html += `<td class="${cellClass}">${formatHolderVal(val, m.format)}</td>`;
            });
            html += '</tr>';
        });
    });

    html += '</tbody></table>';
    
    // 添加两个图表容器
    html += `
        <div class="holders-charts-container">
            <div class="holders-chart">
                <div class="chart-title">变化率分析</div>
                <canvas id="holdersChart1"></canvas>
            </div>
            <div class="holders-chart">
                <div class="chart-title">股东人数与户均持股</div>
                <canvas id="holdersChart2"></canvas>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // 绘制图表
    setTimeout(() => {
        renderHoldersChart1(processedData);
        renderHoldersChart2(processedData);
    }, 100);
}

// TOP 10 Shareholders 渲染函数
function renderTop10Shareholders() {
    const container = document.getElementById('table-box');
    
    if (!top10DataLoaded || !top10ShareholdersData.length) {
        container.innerHTML = '<div class="loading">TOP 10 股东数据加载中或无数据...</div>';
        return;
    }
    
    // 获取所有唯一的报告期并按日期排序（最新在左边）
    const reportDatesSet = new Set(top10ShareholdersData.map(d => d.report_date));
    const reportDates = Array.from(reportDatesSet).sort((a, b) => b.localeCompare(a));
    
    // 获取最新一期的数据
    const latestDate = reportDates[0];
    const latestData = top10ShareholdersData.filter(d => d.report_date === latestDate);
    
    // 获取所有唯一的股东名称
    const shareholdersSet = new Set(top10ShareholdersData.map(d => d.shareholder_name));
    const allShareholders = Array.from(shareholdersSet);
    
    // 按最新一期持股比例排序
    const latestHoldingMap = new Map();
    latestData.forEach(d => {
        latestHoldingMap.set(d.shareholder_name, d.holding_ratio || 0);
    });
    
    allShareholders.sort((a, b) => {
        const ratioA = latestHoldingMap.get(a) || 0;
        const ratioB = latestHoldingMap.get(b) || 0;
        return ratioB - ratioA; // 降序
    });
    
    // 构建数据矩阵：股东 x 报告期
    const dataMatrix = new Map();
    top10ShareholdersData.forEach(d => {
        const key = `${d.shareholder_name}_${d.report_date}`;
        dataMatrix.set(key, {
            holding_ratio: d.holding_ratio,
            shares_held: d.shares_held,
            rank: d.rank,
            change_amount: d.change_amount
        });
    });
    
    // 格式化报告期显示
    const formatReportDate = (dateStr) => {
        if (!dateStr) return '';
        // 格式: 20160331 -> 2016Q1
        const year = dateStr.substring(0, 4);
        const month = dateStr.substring(4, 6);
        const quarterMap = { '03': 'Q1', '06': 'Q2', '09': 'Q3', '12': 'Q4' };
        const quarter = quarterMap[month] || month;
        return `${year}${quarter}`;
    };
    
    // 格式化持股比例
    const formatRatio = (val) => {
        if (val === null || val === undefined || isNaN(val)) return '-';
        return Number(val).toFixed(2) + '%';
    };
    
    // 格式化持股数量
    const formatShares = (val) => {
        if (val === null || val === undefined || isNaN(val)) return '-';
        const num = Number(val);
        if (num >= 1e8) return (num / 1e8).toFixed(2) + '亿';
        if (num >= 1e4) return (num / 1e4).toFixed(2) + '万';
        return num.toLocaleString();
    };
    
    // 获取单元格背景色（持股比例越高颜色越深，字体始终深色）
    const getCellStyle = (ratio, isLatest) => {
        if (ratio === null || ratio === undefined || isNaN(ratio)) return 'color: #333;';
        const r = Number(ratio);
        if (r >= 20) return 'background-color: #1565c0; color: #000; font-weight: 600;';
        if (r >= 10) return 'background-color: #42a5f5; color: #000; font-weight: 600;';
        if (r >= 5) return 'background-color: #90caf9; color: #333;';
        if (r >= 2) return 'background-color: #bbdefb; color: #333;';
        if (r > 0) return 'background-color: #e3f2fd; color: #333;';
        return 'color: #333;';
    };
    
    let html = `
        <style>
            .top10-table { font-size: 11px; color: #333; }
            .top10-table th { 
                background: var(--header-bg); 
                position: sticky; 
                top: 0; 
                z-index: 10;
                white-space: nowrap;
                padding: 8px 6px;
                color: #333;
                font-weight: 600;
            }
            .top10-table td { 
                padding: 6px 8px; 
                text-align: center;
                white-space: nowrap;
                color: #333;
            }
            .top10-table td:first-child { 
                text-align: left; 
                position: sticky; 
                left: 0; 
                background: white; 
                z-index: 5;
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: 500;
                color: #222;
            }
            .top10-table tr:hover td { background-color: #f5f5f5 !important; }
            .top10-table tr:hover td:first-child { background-color: #f5f5f5 !important; }
            .shareholder-rank { 
                display: inline-block; 
                width: 18px; 
                height: 18px; 
                line-height: 18px; 
                text-align: center; 
                border-radius: 50%; 
                font-size: 10px; 
                margin-right: 4px;
                font-weight: bold;
            }
            .rank-1 { background: #ffd700; color: #333; }
            .rank-2 { background: #c0c0c0; color: #333; }
            .rank-3 { background: #cd7f32; color: #333; }
            .rank-other { background: #e0e0e0; color: #333; }
            .change-new { color: #c62828; font-weight: bold; }
            .change-up { color: #2e7d32; font-weight: bold; }
            .change-down { color: #c62828; font-weight: bold; }
            .latest-column { background-color: #fff3e0 !important; }
            .ratio-text { color: #333; font-weight: 500; }
        </style>
        <table class="top10-table"><thead><tr>
            <th style="min-width: 180px;">股东名称</th>`;
    
    // 表头：报告期
    reportDates.forEach((date, idx) => {
        const isLatest = idx === 0;
        html += `<th class="${isLatest ? 'latest-column' : ''}">${formatReportDate(date)}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // 表体：每个股东一行
    allShareholders.forEach(shareholder => {
        html += `<tr><td title="${shareholder}">${shareholder}</td>`;
        
        reportDates.forEach((date, idx) => {
            const isLatest = idx === 0;
            const key = `${shareholder}_${date}`;
            const cellData = dataMatrix.get(key);
            
            if (cellData) {
                const style = getCellStyle(cellData.holding_ratio, isLatest);
                const rankClass = cellData.rank === 1 ? 'rank-1' : 
                                  cellData.rank === 2 ? 'rank-2' : 
                                  cellData.rank === 3 ? 'rank-3' : 'rank-other';
                
                // 判断变化类型
                let changeIndicator = '';
                if (cellData.change_amount) {
                    const changeStr = String(cellData.change_amount);
                    if (changeStr === '新进' || changeStr.includes('新进')) {
                        changeIndicator = '<span class="change-new">新</span>';
                    } else if (changeStr.startsWith('-') || changeStr.includes('减')) {
                        changeIndicator = '<span class="change-down">↓</span>';
                    } else if (changeStr !== '不变' && changeStr !== '0' && !changeStr.startsWith('0')) {
                        changeIndicator = '<span class="change-up">↑</span>';
                    }
                }
                
                const title = `${shareholder}\n持股: ${formatShares(cellData.shares_held)}\n比例: ${formatRatio(cellData.holding_ratio)}\n名次: ${cellData.rank}\n变动: ${cellData.change_amount || '-'}`;
                
                html += `<td class="${isLatest ? 'latest-column' : ''}" style="${style}" title="${title}">
                    <span class="shareholder-rank ${rankClass}">${cellData.rank}</span>
                    <span class="ratio-text">${formatRatio(cellData.holding_ratio)}</span>
                    ${changeIndicator}
                </td>`;
            } else {
                html += `<td class="${isLatest ? 'latest-column' : ''}">-</td>`;
            }
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    // 添加图例说明
    html += `
        <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 11px;">
            <strong>图例说明：</strong>
            <span style="margin-left: 15px;"><span class="shareholder-rank rank-1">1</span> 第1大股东</span>
            <span style="margin-left: 10px;"><span class="shareholder-rank rank-2">2</span> 第2大股东</span>
            <span style="margin-left: 10px;"><span class="shareholder-rank rank-3">3</span> 第3大股东</span>
            <span style="margin-left: 15px; color: #e53935; font-weight: bold;">新</span> 新进
            <span style="margin-left: 10px; color: #43a047;">↑</span> 增持
            <span style="margin-left: 10px; color: #e53935;">↓</span> 减持
            <span style="margin-left: 15px;">背景颜色深浅表示持股比例高低</span>
        </div>
    `;
    
    container.innerHTML = html;
}

// 图表1: 柱状图（总户数减少率、总市值增加率、户均持股金额增长率）+ 折线图（总市值）
function renderHoldersChart1(data) {
    const canvas = document.getElementById('holdersChart1');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.parentElement.clientWidth - 40;
    const height = 280;
    canvas.width = width;
    canvas.height = height;
    
    // 反转数据（按日期升序）
    const chartData = [...data].reverse();
    
    const padding = { top: 50, right: 80, bottom: 70, left: 60 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    
    // 清空画布
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, width, height);
    
    // 获取数据范围
    const holderChangePcts = chartData.map(d => d.holder_count_change_pct).filter(v => v !== null);
    const mktCapChangePcts = chartData.map(d => d.market_cap_change_pct).filter(v => v !== null);
    const avgChangePcts = chartData.map(d => d.avg_shares_change_pct).filter(v => v !== null);
    const mktCaps = chartData.map(d => d.Market_Cap_Billion).filter(v => v !== null && v > 0);
    
    const allPcts = [...holderChangePcts, ...mktCapChangePcts, ...avgChangePcts];
    if (!allPcts.length) return;
    
    const minPct = Math.min(...allPcts, 0);
    const maxPct = Math.max(...allPcts, 0);
    const pctRange = Math.max(Math.abs(minPct), Math.abs(maxPct)) * 1.2;
    const maxMktCap = mktCaps.length ? Math.max(...mktCaps) * 1.1 : 500;
    const minMktCap = mktCaps.length ? Math.min(...mktCaps) * 0.9 : 0;
    
    const barGroupWidth = chartWidth / chartData.length;
    const barWidth = barGroupWidth * 0.2;
    const barGap = barGroupWidth * 0.05;
    
    // 绘制网格线
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
    }
    
    // 绘制零线
    const zeroY = padding.top + chartHeight / 2;
    ctx.strokeStyle = '#999';
    ctx.beginPath();
    ctx.moveTo(padding.left, zeroY);
    ctx.lineTo(width - padding.right, zeroY);
    ctx.stroke();
    
    // 柱状图颜色
    const colors = {
        holderChange: '#4472C4',    // 蓝色 - 总户数减少率
        mktCapChange: '#A5A5A5',    // 灰色 - 总市值增加率
        avgChange: '#FFC000'        // 黄色 - 户均持股金额增长率
    };
    
    // 绘制柱状图
    chartData.forEach((d, i) => {
        const groupX = padding.left + i * barGroupWidth;
        
        // 总户数减少率（蓝色）
        const holderPct = d.holder_count_change_pct || 0;
        const holderBarHeight = (Math.abs(holderPct) / pctRange) * (chartHeight / 2);
        ctx.fillStyle = colors.holderChange;
        if (holderPct >= 0) {
            ctx.fillRect(groupX + barGap, zeroY - holderBarHeight, barWidth, holderBarHeight);
        } else {
            ctx.fillRect(groupX + barGap, zeroY, barWidth, holderBarHeight);
        }
        
        // 总市值增加率（灰色）
        const mktCapPct = d.market_cap_change_pct || 0;
        const mktCapBarHeight = (Math.abs(mktCapPct) / pctRange) * (chartHeight / 2);
        ctx.fillStyle = colors.mktCapChange;
        if (mktCapPct >= 0) {
            ctx.fillRect(groupX + barGap + barWidth + 2, zeroY - mktCapBarHeight, barWidth, mktCapBarHeight);
        } else {
            ctx.fillRect(groupX + barGap + barWidth + 2, zeroY, barWidth, mktCapBarHeight);
        }
        
        // 户均持股金额增长率（黄色）
        const avgPct = d.avg_shares_change_pct || 0;
        const avgBarHeight = (Math.abs(avgPct) / pctRange) * (chartHeight / 2);
        ctx.fillStyle = colors.avgChange;
        if (avgPct >= 0) {
            ctx.fillRect(groupX + barGap + (barWidth + 2) * 2, zeroY - avgBarHeight, barWidth, avgBarHeight);
        } else {
            ctx.fillRect(groupX + barGap + (barWidth + 2) * 2, zeroY, barWidth, avgBarHeight);
        }
    });
    
    // 绘制折线（总市值）
    ctx.strokeStyle = '#ED7D31';  // 橙色
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started = false;
    chartData.forEach((d, i) => {
        if (d.Market_Cap_Billion === null) return;
        const x = padding.left + i * barGroupWidth + barGroupWidth / 2;
        const y = padding.top + chartHeight - ((d.Market_Cap_Billion - minMktCap) / (maxMktCap - minMktCap)) * chartHeight;
        if (!started) {
            ctx.moveTo(x, y);
            started = true;
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
    
    // 绘制图例
    const legendY = 15;
    const legendItems = [
        { color: colors.holderChange, label: '总户数减少率' },
        { color: colors.mktCapChange, label: '总市值增加率' },
        { color: colors.avgChange, label: '户均持股金额增长率' },
        { color: '#ED7D31', label: '总市值(亿元)', isLine: true }
    ];
    
    ctx.font = '11px sans-serif';
    let legendX = padding.left;
    legendItems.forEach(item => {
        if (item.isLine) {
            ctx.strokeStyle = item.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(legendX, legendY + 5);
            ctx.lineTo(legendX + 20, legendY + 5);
            ctx.stroke();
        } else {
            ctx.fillStyle = item.color;
            ctx.fillRect(legendX, legendY, 12, 10);
        }
        ctx.fillStyle = '#333';
        ctx.fillText(item.label, legendX + 25, legendY + 9);
        legendX += ctx.measureText(item.label).width + 50;
    });
    
    // 绘制X轴标签
    ctx.fillStyle = '#666';
    ctx.font = '10px sans-serif';
    chartData.forEach((d, i) => {
        if (i % 4 === 0) {
            const x = padding.left + i * barGroupWidth + barGroupWidth / 2;
            const date = new Date(d.report_date);
            const label = `${date.getFullYear()}/${date.getMonth() + 1}/1`;
            ctx.save();
            ctx.translate(x, height - padding.bottom + 15);
            ctx.rotate(-Math.PI / 4);
            ctx.fillText(label, 0, 0);
            ctx.restore();
        }
    });
    
    // 绘制左Y轴标签（百分比）
    ctx.fillStyle = '#666';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    for (let i = -2; i <= 2; i++) {
        const pctVal = Math.round(pctRange * i / 2);
        const y = zeroY - (i / 2) * (chartHeight / 2);
        ctx.fillText(`${pctVal}%`, padding.left - 5, y + 3);
    }
    ctx.textAlign = 'left';
}

// 图表2: 折线图（股东总户数、户均持股金额）
function renderHoldersChart2(data) {
    const canvas = document.getElementById('holdersChart2');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.parentElement.clientWidth - 40;
    const height = 280;
    canvas.width = width;
    canvas.height = height;
    
    // 反转数据（按日期升序）
    const chartData = [...data].reverse();
    
    const padding = { top: 50, right: 80, bottom: 70, left: 70 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    
    // 清空画布
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, width, height);
    
    // 获取数据范围
    const holderCounts = chartData.map(d => d.holder_count).filter(v => v > 0);
    const avgAmounts = chartData.map(d => d.avg_shares_per_holder).filter(v => v !== null && v > 0);
    
    if (!holderCounts.length) return;
    
    const maxHolder = Math.max(...holderCounts) * 1.1;
    const minHolder = Math.min(...holderCounts) * 0.9;
    const maxAvg = avgAmounts.length ? Math.max(...avgAmounts) * 1.1 : 100;
    const minAvg = avgAmounts.length ? Math.min(...avgAmounts) * 0.9 : 0;
    
    // 绘制网格线
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 5; i++) {
        const y = padding.top + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
    }
    
    const barGroupWidth = chartWidth / chartData.length;
    
    // 绘制折线1（股东总户数 - 蓝色）
    ctx.strokeStyle = '#4472C4';
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started1 = false;
    chartData.forEach((d, i) => {
        if (!d.holder_count) return;
        const x = padding.left + i * barGroupWidth + barGroupWidth / 2;
        const y = padding.top + chartHeight - ((d.holder_count - minHolder) / (maxHolder - minHolder)) * chartHeight;
        if (!started1) {
            ctx.moveTo(x, y);
            started1 = true;
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
    
    // 绘制折线2（户均持股金额 - 绿色）
    ctx.strokeStyle = '#70AD47';
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started2 = false;
    chartData.forEach((d, i) => {
        if (d.avg_shares_per_holder === null) return;
        const x = padding.left + i * barGroupWidth + barGroupWidth / 2;
        const y = padding.top + chartHeight - ((d.avg_shares_per_holder - minAvg) / (maxAvg - minAvg)) * chartHeight;
        if (!started2) {
            ctx.moveTo(x, y);
            started2 = true;
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
    
    // 绘制图例
    const legendY = 15;
    ctx.font = '11px sans-serif';
    
    // 股东总户数
    ctx.strokeStyle = '#4472C4';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(padding.left, legendY + 5);
    ctx.lineTo(padding.left + 25, legendY + 5);
    ctx.stroke();
    ctx.fillStyle = '#333';
    ctx.fillText('股东总户数', padding.left + 30, legendY + 9);
    
    // 户均持股金额
    ctx.strokeStyle = '#70AD47';
    ctx.beginPath();
    ctx.moveTo(padding.left + 130, legendY + 5);
    ctx.lineTo(padding.left + 155, legendY + 5);
    ctx.stroke();
    ctx.fillStyle = '#333';
    ctx.fillText('户均持股金额(万元)', padding.left + 160, legendY + 9);
    
    // 绘制X轴标签
    ctx.fillStyle = '#666';
    ctx.font = '10px sans-serif';
    chartData.forEach((d, i) => {
        if (i % 4 === 0) {
            const x = padding.left + i * barGroupWidth + barGroupWidth / 2;
            const date = new Date(d.report_date);
            const label = `${date.getFullYear()}/${date.getMonth() + 1}/1`;
            ctx.save();
            ctx.translate(x, height - padding.bottom + 15);
            ctx.rotate(-Math.PI / 4);
            ctx.fillText(label, 0, 0);
            ctx.restore();
        }
    });
    
    // 绘制左Y轴标签（股东人数）
    ctx.fillStyle = '#4472C4';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
        const val = minHolder + (maxHolder - minHolder) * (5 - i) / 5;
        const y = padding.top + (chartHeight / 5) * i;
        ctx.fillText(Math.round(val).toLocaleString(), padding.left - 5, y + 3);
    }
    
    // 绘制右Y轴标签（户均持股金额）
    ctx.fillStyle = '#70AD47';
    ctx.textAlign = 'left';
    for (let i = 0; i <= 5; i++) {
        const val = minAvg + (maxAvg - minAvg) * (5 - i) / 5;
        const y = padding.top + (chartHeight / 5) * i;
        ctx.fillText(val.toFixed(1), width - padding.right + 5, y + 3);
    }
    ctx.textAlign = 'left';
}

// Initialize on page load
window.onload = function() {
    console.log("Page loaded, initializing...");
    try {
        initTabs();
        loadData();
        // Initialize Lumina style
        initLuminaUI();
    } catch (err) {
        console.error("Initialization error:", err);
        document.getElementById('table-box').innerHTML = `<div class="loading" style="color:red;">Initialization error: ${err.message}</div>`;
    }
};

// ============================================
// LUMINA STYLE UI ENHANCEMENT
// ============================================
function initLuminaUI() {
    // Initialize WebGL Background
    initWebGLBackground();
    
    // Re-bind search input for new layout
    const searchInput = document.getElementById('company-search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadData();
        });
    }
    
    // Initial animation
    if (typeof gsap !== 'undefined') {
        gsap.from('.fade-in', {
            opacity: 0,
            y: 20,
            duration: 0.8,
            stagger: 0.1,
            ease: "power3.out"
        });
    }
}

// Lumina Style Tab Switching
function switchTab(tabId) {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        const label = item.querySelector('.nav-label');
        if (!label) return;
        const labelText = label.textContent;
        if (labelText === tabId || 
            (labelText === 'Highlights' && tabId === 'Highlights') ||
            (labelText === 'Financials' && tabId === 'IncomeStatement') || 
            (labelText === 'Holders' && tabId === 'Holders') ||
            (labelText === 'Top 10' && tabId === 'Top10')) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    // Update Section Header
    const indexMap = { 'Highlights': '01', 'IncomeStatement': '02', 'Holders': '03', 'Top10': '04' };
    const descMap = {
        'Highlights': 'A comprehensive look at the core performance metrics, valuation, and market position.',
        'IncomeStatement': 'Detailed breakdown of revenue, costs, and profitability over time.',
        'Holders': 'Analysis of shareholder base growth and average holdings.',
        'Top10': 'The most significant stakeholders and their recent position changes.'
    };
    const titleMap = { 'Highlights': 'Highlights', 'IncomeStatement': 'Financials', 'Holders': 'Holders', 'Top10': 'Top 10' };

    const indexEl = document.getElementById('current-section-index');
    const titleEl = document.getElementById('current-section-title');
    const descEl = document.getElementById('current-section-desc');
    
    if (indexEl) indexEl.textContent = indexMap[tabId] || '01';
    if (titleEl) titleEl.textContent = titleMap[tabId] || tabId;
    if (descEl) descEl.textContent = descMap[tabId] || '';

    // Toggle Holders Charts
    const holdersCharts = document.getElementById('holders-charts');
    if (holdersCharts) holdersCharts.style.display = (tabId === 'Holders') ? 'block' : 'none';

    // Call original tab switching logic
    if (tabId === 'Holders') {
        if (typeof renderHolders === 'function') renderHolders();
    } else if (tabId === 'Top10') {
        if (typeof renderTop10Shareholders === 'function') renderTop10Shareholders();
    } else {
        setTab(tabId);
    }

    // Animation
    if (typeof gsap !== 'undefined') {
        gsap.from('.fade-in', {
            opacity: 0,
            y: 20,
            duration: 0.8,
            stagger: 0.1,
            ease: "power3.out"
        });
    }
}

// WebGL Background Logic
function initWebGLBackground() {
    const canvas = document.getElementById('webgl-canvas');
    if (!canvas || typeof THREE === 'undefined') return;
    
    try {
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        // Create a subtle animated mesh
        const geometry = new THREE.IcosahedronGeometry(10, 2);
        const material = new THREE.MeshPhongMaterial({
            color: 0xd4af37,
            wireframe: true,
            transparent: true,
            opacity: 0.05
        });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 1, 2);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        function animate() {
            requestAnimationFrame(animate);
            mesh.rotation.x += 0.001;
            mesh.rotation.y += 0.002;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    } catch (e) {
        console.warn('WebGL initialization failed:', e);
    }
}
</script>

</body>
</html>
